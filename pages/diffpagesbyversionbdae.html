<!DOCTYPE html>
<html>

<!-- Mirrored from doc.ez.no/pages/diffpagesbyversion.action?pageId=31430152&selectedPageVersions=21&selectedPageVersions=22 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 09:37:54 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <title>Page Comparison - HTTP Cache (v.21 vs v.22) - Developer - eZ Documentation</title>

        

                        
    
                        
    
                        
    

    <meta http-equiv="X-UA-Compatible" content="IE=EDGE,chrome=IE7">
<meta charset="UTF-8">
<meta id="confluence-context-path" name="confluence-context-path" content="">
<meta id="confluence-base-url" name="confluence-base-url" content="../index.html">

<meta id="atlassian-token" name="atlassian-token" content="9996d8127abd36d1b757536de859090f8b455d10">


<meta id="confluence-space-key" name="confluence-space-key" content="DEVELOPER">
<script type="text/javascript">
        var contextPath = '';
</script>

    

    <meta name="robots" content="noindex,nofollow">
    <meta name="robots" content="noarchive">
    <meta name="confluence-request-time" content="1485850953308">
        
    
        
            <meta name="ajs-is-space-admin" content=""> <meta name="ajs-has-space-config" content="">
            <meta name="ajs-use-keyboard-shortcuts" content="true">
            <meta name="ajs-discovered-plugin-features" content="$discoveredList">
            <meta name="stp-license-product-name" content="Confluence"/> <meta name="stp-license-days-to-expiry" content="807"/> <meta name="stp-license-is-admin" content="false"/> <meta name="stp-license-should-keep-banner-hidden" content="true"/>
            <meta name="ajs-keyboardshortcut-hash" content="206314443b3cf79696d4ad89324a059c">
            <meta id="team-calendars-has-jira-link" content="true">
            <meta name="ajs-team-calendars-display-time-format" content="displayTimeFormat12">
            <meta id="team-calendars-user-timezone" content="UTC">
            <script type="text/x-template" id="team-calendars-messages" title="team-calendars-messages"><fieldset class="i18n hidden"><input type="hidden" name="calendar3.month.long.july" value="July"><input type="hidden" name="calendar3.day.short.wednesday" value="Wed"><input type="hidden" name="calendar3.day.short.thursday" value="Thu"><input type="hidden" name="calendar3.month.short.march" value="Mar"><input type="hidden" name="calendar3.month.long.april" value="April"><input type="hidden" name="calendar3.month.long.october" value="October"><input type="hidden" name="calendar3.month.long.august" value="August"><input type="hidden" name="calendar3.month.short.july" value="Jul"><input type="hidden" name="calendar3.month.short.may" value="May"><input type="hidden" name="calendar3.month.short.november" value="Nov"><input type="hidden" name="calendar3.day.long.friday" value="Friday"><input type="hidden" name="calendar3.day.long.sunday" value="Sunday"><input type="hidden" name="calendar3.day.long.saturday" value="Saturday"><input type="hidden" name="calendar3.month.short.april" value="Apr"><input type="hidden" name="calendar3.day.long.wednesday" value="Wednesday"><input type="hidden" name="calendar3.month.long.december" value="December"><input type="hidden" name="calendar3.month.short.october" value="Oct"><input type="hidden" name="calendar3.day.long.monday" value="Monday"><input type="hidden" name="calendar3.month.short.june" value="Jun"><input type="hidden" name="calendar3.day.short.monday" value="Mon"><input type="hidden" name="calendar3.day.short.tuesday" value="Tue"><input type="hidden" name="calendar3.day.short.saturday" value="Sat"><input type="hidden" name="calendar3.month.long.march" value="March"><input type="hidden" name="calendar3.month.long.june" value="June"><input type="hidden" name="calendar3.month.short.february" value="Feb"><input type="hidden" name="calendar3.month.short.august" value="Aug"><input type="hidden" name="calendar3.month.short.december" value="Dec"><input type="hidden" name="calendar3.day.short.sunday" value="Sun"><input type="hidden" name="calendar3.month.long.february" value="February"><input type="hidden" name="calendar3.day.long.tuesday" value="Tuesday"><input type="hidden" name="calendar3.month.long.may" value="May"><input type="hidden" name="calendar3.month.long.september" value="September"><input type="hidden" name="calendar3.month.long.november" value="November"><input type="hidden" name="calendar3.month.short.january" value="Jan"><input type="hidden" name="calendar3.month.short.september" value="Sep"><input type="hidden" name="calendar3.day.long.thursday" value="Thursday"><input type="hidden" name="calendar3.month.long.january" value="January"><input type="hidden" name="calendar3.day.short.friday" value="Fri"></fieldset></script>
            <meta name="ajs-is-confluence-admin" content="false">
            <meta name="ajs-connection-timeout" content="10000">
            
    
    
            <meta name="ajs-page-id" content="31430152">
            <meta name="ajs-latest-page-id" content="31430152">
            <meta name="ajs-content-type" content="page">
            <meta name="ajs-page-title" content="HTTP Cache">
            <meta name="ajs-parent-page-title" content="The Complete Guide to eZ Platform">
            <meta name="ajs-parent-page-id" content="31429526">
            <meta name="ajs-space-key" content="DEVELOPER">
            <meta name="ajs-space-name" content="Developer">
            <meta name="ajs-from-page-title" content="">
            <meta name="ajs-can-remove-page" content="false">
            <meta name="ajs-context-path" content="">
            <meta name="ajs-base-url" content="https://doc.ez.no">
            <meta name="ajs-version-number" content="5.8.5">
            <meta name="ajs-build-number" content="5983">
            <meta name="ajs-remote-user" content="">
            <meta name="ajs-remote-user-key" content="">
            <meta name="ajs-current-user-fullname" content="">
            <meta name="ajs-current-user-avatar-url" content="">
            <meta name="ajs-static-resource-url-prefix" content="/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_">
            <meta name="ajs-global-settings-attachment-max-size" content="10485760">
            <meta name="ajs-user-locale" content="en_GB">
            <meta name="ajs-enabled-dark-features" content="confluence-inline-comments-resolved,notification.plugin.api.enabled.com.atlassian.confluence.plugins.sharepage.api.ShareContentEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.mentions.api.ConfluenceMentionEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.security.ForgotPasswordEvent,pdf-preview,notification.plugin.api.enabled.com.atlassian.confluence.plugins.tasklist.event.SendTaskEmailEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.page.async.PageMovedEvent,previews.sharing,previews.versions,notification.plugin.api.enabled.com.atlassian.confluence.plugins.files.notifications.event.FileContentUpdateEvent,file-annotations,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.attachment.AttachmentBatchUploadCompletedEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.comment.CommentCreateEvent,notification.plugin.api.enabled.com.atlassian.confluence.efi.emails.events.OnboardingLessUsersEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.files.notifications.event.FileContentRemoveEvent,atlassian.aui.raphael.disabled,previews.conversion-service,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.comment.CommentUpdateEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.follow.FollowEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.page.async.PageEditedEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.blogpost.BlogPostCreateEvent,previews.trigger-all-file-types,notification.plugin.api.enabled.com.atlassian.confluence.plugins.inlinecomments.events.InlineCommentResolveEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.like.LikeCreatedEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.inlinecomments.events.InlineCommentCreateEvent,previews.sharing.pushstate,confluence-inline-comments-rich-editor,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.blogpost.BlogPostUpdateEvent,file-annotations.likes,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.page.async.PageCreatedEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.files.notifications.event.FileContentMentionUpdateEvent,notification.plugin.api.enabled.com.atlassian.confluence.efi.emails.events.OnboardingNoSpaceCreatedEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.hipchat.api.events.HipChatUserMapped,notification.plugin.api.enabled.com.atlassian.confluence.plugins.sharepage.api.ShareAttachmentEvent,confluence-inline-comments,confluence-inline-comments-dangling-comment,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.blogpost.BlogPostMovedEvent">
            <meta name="ajs-atl-token" content="9996d8127abd36d1b757536de859090f8b455d10">
            <meta name="ajs-confluence-flavour" content="VANILLA">
            <meta name="ajs-user-date-pattern" content="dd MMM yyyy">
            <meta name="ajs-date.format" content="MMM dd, yyyy">
    
    <link rel="shortcut icon" href="https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/favicon.ico">

<link rel="search" type="application/opensearchdescription+xml" href="https://doc.ez.no/opensearch/osd.action" title="eZ Documentation"/>

<script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-nps-plugin:atlassian-nps-plugin-resources.is-server-instance-data-provider"]="true";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.confluence.plugins.confluence-license-banner:confluence-license-banner-resources.license-details"]="{\"daysBeforeLicenseExpiry\":0,\"daysBeforeMaintenanceExpiry\":0,\"showLicenseExpiryBanner\":false,\"showMaintenanceExpiryBanner\":false,\"renewUrl\":null,\"salesEmail\":null}";
WRM._unparsedData["com.atlassian.plugins.atlassian-nps-plugin:nps-acknowledgement-resources.analytics-enabled-data-provider"]="\"false\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-nps-plugin:nps-acknowledgement-resources.sen-data-provider"]="\"SEN-2255945\"";
WRM._unparsedData["com.atlassian.confluence.plugins.confluence-feature-discovery-plugin:confluence-feature-discovery-plugin-resources.test-mode"]="false";
</script>
<link type="text/css" rel="stylesheet" href="https://doc.ez.no/s/1b9968ac17721e3a6947d14e3a43c3f8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?build-number=5983" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="https://doc.ez.no/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f10c36425b731f08af1bde9c7e745307/_/download/contextbatch/css/pagediffs/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f10c36425b731f08af1bde9c7e745307/_/download/contextbatch/css/pagediffs/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="https://doc.ez.no/s/e07f58c44d24a6e17f8354bdec890e2f-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/8d89db3a01c02cb5eb7fc39a28427136/_/download/contextbatch/css/atl.confluence.plugins.pagetree-desktop,main,atl.general,page/batch.css?flavour=VANILLA" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/8d89db3a01c02cb5eb7fc39a28427136/_/download/contextbatch/css/atl.confluence.plugins.pagetree-desktop,main,atl.general,page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/7893b9affdc3bf828ad93d0610d3d5f3-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/8d89db3a01c02cb5eb7fc39a28427136/_/download/contextbatch/css/atl.confluence.plugins.pagetree-desktop,main,atl.general,page/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="https://doc.ez.no/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/3a21f7b21af4c67045d1e0255f2ac570/_/download/contextbatch/css/theme.doc/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="https://doc.ez.no/s/dfa57710662c34cadfcdc17e2cded5b2-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/3.0.11/_/download/batch/confluence.extra.livesearch:livesearch-macro-web-resources/confluence.extra.livesearch:livesearch-macro-web-resources.css" media="all">
<link type="text/css" rel="stylesheet" href="https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/6/_/styles/colors.css?spaceKey=DEVELOPER" media="all">
<link type="text/css" rel="stylesheet" href="https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/6/_/styles/custom.css?spaceKey=DEVELOPER" media="all">
<script type="text/javascript" src="https://doc.ez.no/s/1f7b22082ef39a4bb134622dae929bdc-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/js/batch.js?atlassian.aui.raphael.disabled=true&amp;locale=en-GB&amp;build-number=5983" ></script>
<script type="text/javascript" src="https://doc.ez.no/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f10c36425b731f08af1bde9c7e745307/_/download/contextbatch/js/pagediffs/batch.js" ></script>
<script type="text/javascript" src="https://doc.ez.no/s/1cb5afbbf3aea39263d8912ec2a029e3-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/8d89db3a01c02cb5eb7fc39a28427136/_/download/contextbatch/js/atl.confluence.plugins.pagetree-desktop,main,atl.general,page/batch.js?locale=en-GB&amp;flavour=VANILLA&amp;anonymous-access-enabled=true&amp;is-server-instance=true&amp;hostenabled=true" ></script>
<script type="text/javascript" src="https://doc.ez.no/s/6c0981174e94142364564819dc0d1413-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/3.0.11/_/download/batch/confluence.extra.livesearch:livesearch-macro-web-resources/confluence.extra.livesearch:livesearch-macro-web-resources.js?locale=en-GB" ></script>


        
            <meta name="stp-license-product-name" content="Confluence"/> <meta name="stp-license-days-to-expiry" content="807"/> <meta name="stp-license-is-admin" content="false"/> <meta name="stp-license-should-keep-banner-hidden" content="true"/>
    

        
    
    

    
                <link rel="canonical" href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache">
        <link rel="shortlink" href="https://doc.ez.no/x/CJbfAQ">
    <meta name="wikilink" content="[DEVELOPER:HTTP Cache]">
    <meta name="page-version" content="22">

</head>

<body             onload="placeFocus()"
     id="com-atlassian-confluence" class="theme-documentation  aui-theme-default aui-layout">

        
            <div id='stp-licenseStatus-banner'></div>
    <div id="full-height-container">
    <div id="header-precursor">
        
                    </div>






<header id="header" role="banner">
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation"><div class="aui-header-inner"><div class="aui-header-before"><a class=" aui-dropdown2-trigger app-switcher-trigger" aria-owns="app-switcher" aria-controls="app-switcher" aria-haspopup="true" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a><div id="app-switcher" class="aui-dropdown2 aui-style-default"><div class="app-switcher-loading">Loading&hellip;</div></div><script>
            (function (NL) {
                var initialise = function () {
                    // For some milestones of AUI, the atlassian soy namespace was renamed to aui. Handle that here by ensuring that window.atlassian is defined.
                    window.atlassian = window.atlassian || window.aui;
                    new NL.AppSwitcher({
                        dropdownContents: '#app-switcher'
                    });
                };
                if (NL.AppSwitcher) {
                    initialise();
                } else {
                    NL.onInit = initialise;
                }
            }(window.NL = (window.NL || {})));
            window.NL.isUserAdmin = false</script></div><div class="aui-header-primary"><h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://doc.ez.no/"><img src="https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/logo/confluence-logo.png" alt="eZ Documentation" /></a></h1><ul class="aui-nav">
                            <li>
            
        
        
<a  id="space-directory-link" href="https://doc.ez.no/spacedirectory/view.action"  class=" aui-nav-imagelink"   title="Spaces">
            <span>Spaces</span>
    </a>
        </li>
                            <li id="browseMenu" role="menu">
            
    
        <a id="browse-menu-link" class="aui-nav-link aui-dropdown2-trigger" href="#" aria-haspopup="true" aria-owns="browse-menu-link-content" title="Browse">
        <span class="browse">Browse</span>
    </a>
    <nav id="browse-menu-link-content" class="aui-dropdown2 aui-style-default" aria-hidden="true">
                    <div class="aui-dropdown2-section">
                                <ul  id="browse-menu-link-leading" class="aui-list-truncate section-leading first">
                                            <li>
    
            
<a  id="space-pages-link" href="https://doc.ez.no/pages/listpages.action?key=DEVELOPER" class="    "      title="Browse pages in the Developer space" >
        Pages
</a>
</li>
                                            <li>
    
            
<a  id="space-blogposts-link" href="https://doc.ez.no/pages/viewrecentblogposts.action?key=DEVELOPER" class="    "      title="Browse blogs in the Developer space" >
        Blog
</a>
</li>
                                            <li>
    
            
<a  id="space-labels-link" href="https://doc.ez.no/labels/listlabels-heatmap.action?key=DEVELOPER" class="    "      title="Browse labels in the Developer space" >
        Labels
</a>
</li>
                                            <li>
    
            
<a  id="space-advanced-link" href="https://doc.ez.no/spaces/viewspacesummary.action?key=DEVELOPER" class="    "      title="Browse additional space functions in the Developer space" >
        Space Operations
</a>
</li>
                                    </ul>
            </div>
            </nav>
    
        </li>
        </ul>
</div><div class="aui-header-secondary"><ul class="aui-nav">
                        <li>
        <form id="quick-search" class="aui-quicksearch dont-default-focus header-quicksearch" action="https://doc.ez.no/dosearchsite.action" method="get"><fieldset><label for="quick-search-query" class="assistive">Quick Search</label><input id="quick-search-query" class="text app-search search quick-search-query" type="text" accessKey="q" autocomplete="off" name="queryString" title="Quick Search" placeholder="Search" /><input id="quick-search-submit" class="quick-search-submit" type="submit" value="Search"/><div class="aui-dd-parent quick-nav-drop-down"></div></fieldset></form>
    </li>
        <li>
            
        <a id="help-menu-link" class="aui-nav-link aui-dropdown2-trigger" href="#" aria-haspopup="true" aria-owns="help-menu-link-content" title="Help">
        <span class="aui-icon aui-icon-small aui-iconfont-help">Help</span>
    </a>
    <nav id="help-menu-link-content" class="aui-dropdown2 aui-style-default" aria-hidden="true">
                    <div class="aui-dropdown2-section">
                                <ul  id="help-menu-link-leading" class="aui-list-truncate section-leading first">
                                            <li>
        
            
<a  id="confluence-help-link" href="https://docs.atlassian.com/confluence/docs-58/Getting+Help+And+Support" class="    "      title="Visit the Confluence documentation home"  target="_blank"
>
        Online Help
</a>
</li>
                                            <li>
    
                
<a  id="keyboard-shortcuts-link" href="#" class="    "      title="View available keyboard shortcuts" >
        Keyboard Shortcuts
</a>
</li>
                                            <li>
    
            
<a  id="feed-builder-link" href="https://doc.ez.no/dashboard/configurerssfeed.action" class="    "      title="Create your custom RSS feed." >
        Feed Builder
</a>
</li>
                                            <li>
    
            
<a  id="whats-new-menu-link" href="https://docs.atlassian.com/confluence/docs-58/whatsnew/iframe" class="    "      title="" >
        What’s new
</a>
</li>
                                            <li>
    
                
<a  id="gadget-directory-link" href="#" class="   user-item administration-link "      title="Browse gadgets provided by Confluence" >
        Available Gadgets
</a>
</li>
                                            <li>
    
            
<a  id="confluence-about-link" href="https://doc.ez.no/aboutconfluencepage.action" class="    "      title="Get more information about Confluence" >
        About Confluence
</a>
</li>
                                    </ul>
            </div>
            </nav>
    
    </li>
        <li>
                
    
    </li>
        <li>
            
    </li>
        <li>
                                            <li>
        
            
<a  id="login-link" href="https://doc.ez.no/login.action?os_destination=%2Fpages%2Fdiffpagesbyversion.action%3FpageId%3D31430152%26selectedPageVersions%3D21%26selectedPageVersions%3D22" class="   user-item login-link "      title="" >
        Log in
</a>
</li>
                        
    </li>
    </ul>
</div></div><!-- .aui-header-inner--></nav><!-- .aui-header -->
    <br class="clear">
</header>

    <div id="splitter">
    <div id="splitter-sidebar" >
        
        <p>&nbsp;</p>
<h4><a name="HTTPCache-&amp;nbsp;General"></a>&nbsp; General</h4>
<p><font color="#999">&bull;</font>&nbsp;&nbsp;<a href="http://ez.no/" class="external-link" rel="nofollow">eZ Systems Website</a><br/>
<font color="#999">&bull;</font>&nbsp;&nbsp;<a href="http://doc.ez.no/display/USER" class="external-link" rel="nofollow">Editor documentation</a></p>
<hr />
<h4><a name="HTTPCache-&amp;nbsp;Developerdocumentation"></a>&nbsp; Developer documentation</h4>
<p>&nbsp;&nbsp;<sup><a href="http://doc.ez.no/display/DEVELOPER" class="external-link" rel="nofollow">Back to the top</a></sup><br/>
    
    


<div class="search-macro search-macro-medium">
    <div class="aui-dd-parent"></div>
    <form class="aui aui-dd-parent" name="livesearchForm" method="POST" action="https://doc.ez.no/dosearchsite.action">
        <fieldset class="search-macro-fields">
            <div class="search-macro-query">
                <input class="text" type="text" name="queryString" autocomplete="off" placeholder="search Developer docs">
                            </div>
                        <button type="submit" class="search-macro-button aui-button">
                <span class="aui-icon aui-icon-small aui-iconfont-search">Search</span>
            </button>
                        <input type="hidden" name="where" value="DEVELOPER">
            <input type="hidden" name="additional" value="space name">
            <input type="hidden" name="labels" value="">
            <input type="hidden" name="contentType" value="page">
        </fieldset>
    </form>
</div>
</p>



<div class="plugin_pagetree">

        
        
    <ul class="plugin_pagetree_children_list plugin_pagetree_children_list_noleftspace">
        <div class="plugin_pagetree_children">
        </div>
    </ul>

    <fieldset class="hidden">
        <input type="hidden" name="treeId" value="">
        <input type="hidden" name="treeRequestId" value="/plugins/pagetree/naturalchildren.action?decorator=none&amp;excerpt=false&amp;sort=position&amp;reverse=false&amp;disableLinks=false&amp;expandCurrent=false">
        <input type="hidden" name="treePageId" value="31430152">

        <input type="hidden" name="noRoot" value="false">
        <input type="hidden" name="rootPageId" value="31429504">

        <input type="hidden" name="rootPage" value="">
        <input type="hidden" name="startDepth" value="0">
        <input type="hidden" name="spaceKey" value="DEVELOPER" >

        <input type="hidden" name="i18n-pagetree.loading" value="Loading...">
        <input type="hidden" name="i18n-pagetree.error.permission" value="Unable to load page tree. It seems that you do not have permission to view the root page.">
        <input type="hidden" name="i18n-pagetree.eeror.general" value="There was a problem retrieving the page tree. Please check the server log file for more information.">
        <input type="hidden" name="loginUrl" value="/login.action?os_destination=%2Fpages%2Fdiffpagesbyversion.action%3FpageId%3D31430152%26selectedPageVersions%3D21%26selectedPageVersions%3D22">
        <input type="hidden" name="mobile" value="false">

                <fieldset class="hidden">
                                                <input type="hidden" name="ancestorId" value="31429526">
                                    <input type="hidden" name="ancestorId" value="31429504">
                                    </fieldset>
    </fieldset>
</div>


    

            </div>
    <div id="splitter-content">

                    <script type="text/javascript" src="https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5.8.5/_/download/resources/com.atlassian.confluence.plugins.doctheme:resources/doc-theme.js"></script>
    
                        
            
<div id="main"  class="aui-page-panel" >
    <div id="main-header">
        
        
    <div id="navigation" class="content-navigation view-information">
                    <ul class="ajs-menu-bar">
                                                                    <li class="ajs-button normal">

        
        
                                            
    
    
    <a  id="viewPageLink" href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache" rel="nofollow" class="aui-button aui-button-subtle view"   title="">
                <span>
                            <span class="aui-icon aui-icon-small aui-iconfont-back-page"></span>
                        View Page
        </span>    </a>
</li>
                                
                    
        <li class="normal ajs-menu-item">
        <a id="action-menu-link" class="action aui-dropdown2-trigger-arrowless aui-button aui-button-subtle ajs-menu-title aui-dropdown2-trigger" href="#" aria-haspopup="true" aria-owns="action-menu" data-container="#navigation">
            <span>
                                    <span class="aui-icon aui-icon-small aui-iconfont-more"></span>
                                
            </span>
        </a>         <div id="action-menu" class="aui-dropdown2 aui-style-default">
                            <ul  id="action-menu-primary"                     class="section-primary first aui-dropdown2-section">
                                            <li>

    
        
                                            
    
    
    <a  id="view-attachments-link" href="https://doc.ez.no/pages/viewpageattachments.action?pageId=31430152" rel="nofollow" class="action-view-attachments"  accessKey="t"  title="View Attachments">
                <span>
                        A<u>t</u>tachments (0)
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-view-history-link" href="https://doc.ez.no/pages/viewpreviousversions.action?pageId=31430152" rel="nofollow" class="action-view-history"   title="">
                <span>
                        Page History
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-page-permissions-link" href="https://doc.ez.no/pages/viewinfo.action?pageId=31430152" rel="nofollow" class="action-page-permissions"   title="Edit restrictions">
                <span>
                        Restrictions
        </span>    </a>
</li>
                                </ul>
                            <ul  id="action-menu-secondary"                     class="section-secondary aui-dropdown2-section">
                                            <li>

    
        
                                            
    
    
    <a  id="view-page-info-link" href="https://doc.ez.no/pages/viewinfo.action?pageId=31430152" rel="nofollow" class="action-view-info"   title="">
                <span>
                        Page Information
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="link-to-page-link" href="https://doc.ez.no/pages/viewinfo.action?pageId=31430152" rel="nofollow" class=""   title="Link to this Page">
                <span>
                        Link to this Page…
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="view-in-hierarchy-link" href="https://doc.ez.no/pages/listpages-dirview.action?key=DEVELOPER&amp;openId=31430152#selectedPageInHierarchy" rel="nofollow" class=""   title="">
                <span>
                        View in Hierarchy
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-view-source-link" href="https://doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=31430152" rel="nofollow" class="action-view-source popup-link"   title="">
                <span>
                        View Source
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-export-pdf-link" href="https://doc.ez.no/spaces/flyingpdf/pdfpageexport.action?pageId=31430152" rel="nofollow" class=""   title="">
                <span>
                        Export to PDF
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-export-word-link" href="https://doc.ez.no/exportword?pageId=31430152" rel="nofollow" class="action-export-word"   title="">
                <span>
                        Export to Word
        </span>    </a>
</li>
                                </ul>
                    </div>
    </li>
            </ul>
    </div>

        
                <div id="title-heading" class="pagetitle with-breadcrumbs">
        
                            <div class="space-logo " data-key="DEVELOPER" data-name="Developer" data-entity-type="confluence.space">
            <a><img class="logo global custom" src="https://doc.ez.no/download/attachments/327681/global.logo?version=1&amp;modificationDate=1434758222000&amp;api=v2" alt=""></a>
        </div>            
                            <div id="breadcrumb-section">
                    
    
    
    <ol id="breadcrumbs">
                                        
                        
        <li class="first" >
                        
                            <span class=""><a href="https://doc.ez.no/display/DEVELOPER">Developer</a></span>
                                                                                            <li id="ellipsis" title="Show all breadcrumbs"><span><strong>&#8230;</strong></span></li>
                                                
                        
        <li class="hidden-crumb" >
                        
                            <span class=""><a href="https://doc.ez.no/display/DEVELOPER/Documentation">Documentation</a></span>
                                                                                    
                        
        <li class="hidden-crumb" >
                        
                            <span class=""><a href="https://doc.ez.no/display/DEVELOPER/The+Complete+Guide+to+eZ+Platform">The Complete Guide to eZ Platform</a></span>
                                                                    
                        
        <li>
                        
                            <span class=""><a href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache">HTTP Cache</a></span>
                                                    </ol>


                </div>
            
            <h1 id="title-text" class="with-breadcrumbs">
                            Page History
                        </h1>
        </div>
    </div>

    

    
    
    
    
    

    

    
                
    
        




        





    

    







    
    
        
    
    
                    
    

    


<div id="content" class="page view-information">
    


<div id="action-messages">
                        </div>



        <script type="text/x-template" title="searchResultsGrid">
    <table class="aui">
        <thead>
            <tr class="header">
                <th class="search-result-title">Page Title</th>
                <th class="search-result-space">Space</th>
                <th class="search-result-date">Updated</th>
            </tr>
        </thead>
    </table>
</script>
<script type="text/x-template" title="searchResultsGridCount">
    <p class="search-result-count">{0}</p>
</script>
<script type="text/x-template" title="searchResultsGridRow">
    <tr class="search-result">
        <td class="search-result-title"><a href="{1}" class="content-type-{2}"><span>{0}</span></a></td>
        <td class="search-result-space"><a class="space" href="/display/{4}/" title="{3}">{3}</a></td>
        <td class="search-result-date"><span class="date" title="{6}">{5}</span></td>
    </tr>
</script>
        
    
    
                            
    
                        
                    <div class="diff-menu">
                <h2 class="diff-title">Versions Compared</h2>

                <div class="page-navigation section">
                                <div class="old page-version article">
                <h3 class="version-title">
                    <a class="page version-navigation view-historical-version-trigger" href="https://doc.ez.no/pages/viewpage.action?pageId=32868452">
                        <span class="assistive">Old Version</span>
                        <span class="version"> 21 </span>
                    </a>
                </h3>
                <p class="metadata author"><span class="assistive">changes.mady.by.user </span>    <a href="https://doc.ez.no/display/~andre.romcke@ez.no"
                       class="url fn"
                            >André Rømcke</a></p>
                <p class="metadata modified"><span class="assistive">Saved on </span><time datetime="2016-10-29 14:43:16.0">Oct 29, 2016</time></p>
            </div>
        
                    <span class="assistive">compared with</span>

                                <div class="new page-version article">
                <h3 class="version-title">
                    <a class="page version-navigation" href="https://doc.ez.no/pages/viewpage.action?pageId=31430152">
                        <span class="assistive">New Version</span>
                        <span class="version"> Current </span>
                    </a>
                </h3>
                <p class="metadata author"><span class="assistive">changes.mady.by.user </span>    <a href="https://doc.ez.no/display/~andre.romcke@ez.no"
                       class="url fn"
                            >André Rømcke</a></p>
                <p class="metadata modified"><span class="assistive">Saved on </span><time datetime="2016-11-11 12:39:57.0">Nov 11, 2016</time></p>
            </div>
        
                    <div class="diff-navigation nav">
                        <ul>
                                                    <li><a class="previous version-navigation" href="https://doc.ez.no/pages/diffpages.action?originalId=32868134&amp;pageId=32868452">
                                <span>Previous Change: Difference between versions 20 and 21</span>
                            </a></li>
                                                                           <li><a class="all version-navigation" href="https://doc.ez.no/pages/viewpreviousversions.action?pageId=31430152">
                                <span>View Page History</span>
                           </a></li>
                        </ul>
                    </div>
                </div>

                        <div class="legend">
            <h2 class="legend-title">Key</h2>
            <ul>
                <li><span class="diff-html-added">This line was added.</span></li>
                <li><span class="diff-html-removed">This line was removed.</span></li>
                <li><span class="diff-html-changed">Formatting was changed.</span></li>
            </ul>
        </div>
    
                                    </div>
                                                                
    
<div id="page-diffs" class="wiki-content">
            <div class="contentLayout2 diff-block-target"><div class="columnLayout two-right-sidebar" data-layout="two-right-sidebar"><div class="cell normal" data-type="normal"><div class="innerCell"><h1 id="HTTPCache-Introduction">Introduction</h1><h2 id="HTTPCache-SmartHTTPcacheclearing">Smart HTTP cache clearing</h2><p><strong>Smart HTTP cache clearing</strong> refers to the ability to clear cache for Locations/content that is in relation with the content being currently cleared.</p><p>When published, any Content item usually has at least one Location, identified by its URL. Therefore, HTTP cache being bound to URLs, if a Content item is updated (a new version is published), we want HTTP cache for all its Locations to be cleared, so the content itself can be updated everywhere it is supposed to be displayed. Sometimes, clearing cache for the content's Locations is not sufficient. You can, for instance, have an excerpt of it displayed in a list from the parent Location, or from within a relation. In this case, cache for the parent Location and/or the relation need to be cleared as well (at least if an ESI is not used).</p><h3 id="HTTPCache-Themechanism">The mechanism</h3><p><strong>Smart HTTP cache clearing</strong> is an event-based mechanism. Whenever a content item needs its cache cleared, the cache purger service sends an <code>ezpublish.cache_clear.content</code> event (also identified by <code>eZ\Publish\Core\MVC\Symfony\MVCEvents::CACHE_CLEAR_CONTENT</code> constant) and passes an <code>eZ\Publish\Core\MVC\Symfony\Event\ContentCacheClearEvent</code> event object. This object contains the ContentInfo object we need to clear the cache for. Every listener for this event can add Location objects to the <em>cache clear list</em>.</p><p>Once the event is dispatched, the purger passes collected Location objects to the purge client, which will effectively send the cache <code>BAN</code> request.</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/info.png);"> </span>Info</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>Note</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body">The event is dispatched with a dedicated event dispatcher, <code>ezpublish.http_cache.event_dispatcher</code>.</td></tr></tbody></table><h3 id="HTTPCache-Defaultbehavior">Default behavior</h3><p>By default, following Locations will be added to the cache clear list:</p><ul class="task-list"><li>All Locations assigned to content (<code>AssignedLocationsListener</code>)</li><li>Parent Location of all Content item's Locations (<code>ParentLocationsListener</code>)</li><li>Locations for content's relations, including reverse relations (<code>RelatedLocationsListener</code>)</li></ul><h3 id="HTTPCache-Implementingacustomlistener">Implementing a custom listener</h3><p>By design, smart HTTP cache clearing is extensible. One can easily implement an event listener/subscriber to the <code>ezpublish.cache_clear.content</code> event and add Locations to the cache clear list.</p><h4 id="HTTPCache-Example">Example</h4><p>Here's a very simple custom listener example, adding an arbitrary Location to the list.</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/note.png);"> </span>Note</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>Important</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body">Cache clear listener services <strong>must</strong> be tagged as <code>ezpublish.http_cache.event_subscriber</code> or <code>ezpublish.http_cache.event_listener</code>.</td></tr></tbody></table><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>php</td></tr><tr><th>theme</th><td>RDark</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>namespace Acme\AcmeTestBundle\EventListener;

use eZ\Publish\API\Repository\LocationService;
use eZ\Publish\Core\MVC\Symfony\Event\ContentCacheClearEvent;
use eZ\Publish\Core\MVC\Symfony\MVCEvents;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;

class ArbitraryLocationsListener implements EventSubscriberInterface
{
    /**
     * @var LocationService
     */
    private $locationService;

    public function __construct( LocationService $locationService )
    {
        $this-&gt;locationService = $locationService;
    }

    public static function getSubscribedEvents()
    {
        return [MVCEvents::CACHE_CLEAR_CONTENT =&gt; ['onContentCacheClear', 100]];
    }

    public function onContentCacheClear( ContentCacheClearEvent $event )
    {
        // $contentInfo is the ContentInfo object for the content being cleared.
        // You can extract information from it (e.g. ContentType from its contentTypeId), using appropriate Repository services.
        $contentInfo = $event-&gt;getContentInfo();

        // Adding arbitrary locations to the cache clear list.
        $event-&gt;addLocationToClear( $this-&gt;locationService-&gt;loadLocation( 123 ) );
        $event-&gt;addLocationToClear( $this-&gt;locationService-&gt;loadLocation( 456 ) );
    }
}</pre></td></tr></tbody></table><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>perl</td></tr><tr><th>theme</th><td>RDark</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>parameters:
    acme.cache_clear.arbitrary_locations_listener.class: Acme\AcmeTestBundle\EventListener\ArbitraryLocationsListener

services:
    acme.cache_clear.arbitrary_locations_listener:
        class: %acme.cache_clear.arbitrary_locations_listener.class%
        arguments: [@ezpublish.api.service.location]
        tags:
            - { name: ezpublish.http_cache.event_subscriber }

</pre></td></tr></tbody></table><h2 id="HTTPCache-ContentCache">Content Cache</h2><p> </p><p>eZ Platform uses <a href="http://symfony.com/doc/current/book/http_cache.html" class="external-link" rel="nofollow">Symfony HttpCache</a> to manage content "view" cache with an <a href="http://symfony.com/doc/current/book/http_cache.html#http-expiration-and-validation" class="external-link" rel="nofollow">expiration model</a>. In addition it is extended <em>(using FOSHttpCache)</em> to add several advanced features. For content coming from the CMS the following is taken advantage of out of the box:</p><ul><li>To be able to always keep cache up to date, cache is made "content-aware" to allow updates to content to trigger <em>cache invalidation.</em><ul><li>Uses a custom <code>X-Location-Id</code> header, which both Symfony and Varnish Proxy are able to invalidate cache on <em><span style="line-height: 1.42857;">(for details see </span><span class="confluence-link"><a href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache#HTTPCache-CachePurge" rel="nofollow">Cache purge</a>.)</span></em></li></ul></li><li>To be able to also cache requests by logged-in users, cache is made "<a href="https://doc.ez.no/pages/viewpage.action?pageId=31430152"><span class="confluence-link"><span class="confluence-link"><span class="confluence-link">context-aware</span></span></span></a><span class="confluence-link"> </span>."<ul><li>Uses a custom vary header <code>X-User-Hash</code> to allow pages to var by user <u>rights</u> <em>(so not per unique user, that is better served by browser cache.)</em></li></ul></li></ul><h3 id="HTTPCache-CacheandExpirationConfiguration">Cache and Expiration Configuration</h3><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>ezplatform.yml</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>ezpublish:
    system:
        my_siteaccess:
            content:
                view_cache: true      # Activates HttpCache for content
                ttl_cache: true       # Activates expiration based HttpCache for content (very fast)
                default_ttl: 60       # Number of seconds an Http response is valid in cache (if ttl_cache is true)</pre></td></tr></tbody></table><h3 id="HTTPCache-Makingyourcontrollerresponsecontent-aware">Making your controller response content-aware</h3><p>Sometimes you need your controller's cache to be invalidated at the same time as specific content changes (i.e. <a href="http://symfony.com/doc/current/book/http_cache.html#using-esi-in-symfony2" class="external-link" rel="nofollow">ESI sub-requests with <code>render</code> twig helper</a>, for a menu for instance). To be able to do that, you just need to add <code><strong>X-Location-Id</strong></code> header to the response object:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>php</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>use Symfony\Component\HttpFoundation\Response;
 
// Inside a controller action
// "Connects" the response to location #123 and sets a max age (TTL) of 1 hour.
$response = new Response();
$response-&gt;headers-&gt;set('X-Location-Id', 123);
$response-&gt;setSharedMaxAge(3600);</pre></td></tr></tbody></table><h3 id="HTTPCache-Makingyourcontrollerresponsecontext-aware">Making your controller response context-aware</h3><p>If the content you're rendering depends on a user's permissions, then you should make the response <span class="confluence-link"><span class="confluence-link">context-aware</span></span>:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>php</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>use Symfony\Component\HttpFoundation\Response;
 
// Inside a controller action
// Tells proxy configured to support this header to take the rights of a user (user hash) into account for the cache
$response = new Response();
$response-&gt;setVary('X-User-Hash');</pre></td></tr></tbody></table><h1 id="HTTPCache-Configuration">Configuration</h1><h2 id="HTTPCache-CachePurge">Cache Purge</h2><p style="margin-left: 0.0px;">This page explains the content cache purge <em>(aka invalidate)</em> mechanism used when publishing content from the UI or from a container-aware script, resulting in cache being invalidated either in the built-in Symfony Reverse Proxy, or on the much faster Varnish reverse proxy.</p><h3 id="HTTPCache-Overview">Overview</h3><p>eZ Platform returns content-related responses with an <code>X-Location-Id</code> header that are stored together by the configured HTTP cache. This allows you to clear <em>(invalidate)</em> HTTP cache representing specifically a given Content item. On publishing the content, a cache purger is triggered with the Content ID in question, which in turn figures out affected content Locations based on <a href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache#HTTPCache-SmartHTTPcacheclearing" rel="nofollow">Smart HTTP cache clearing</a> logic. The returned Location IDs are sent for purge using the purge type explained further below.</p><h3 id="HTTPCache-Purgetypes">Purge types</h3><h4 id="HTTPCache-SymfonyProxy:Localpurgetype">Symfony Proxy: Local purge type</h4><p>By default, invalidation requests will be emulated and sent to the Symfony Proxy cache Store. Cache purge will thus be synchronous, meaning no HTTP purge requests will be sent around when publishing.</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>ezplatform.yml</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>ezpublish:
    http_cache:
        purge_type: local</pre></td></tr></tbody></table><h3 id="HTTPCache-Varnish:HTTPpurgetype">Varnish: HTTP purge type</h3><p>With Varnish you can configure one or several servers that should be purged over HTTP. This purge type is asynchronous, and flushed by the end of Symfony kernel-request/console cycle <em>(during terminate event)</em>. Settings for purge servers can be configured per site group or site access:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>ezplatform.yml</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>ezpublish:
    http_cache:
        purge_type: http

    system:
        my_siteacess:
            http_cache:
                purge_servers: ["http://varnish.server1", "http://varnish.server2", "http://varnish.server3"]</pre></td></tr></tbody></table><p>For further information on setting up Varnish, see <a href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache#HTTPCache-UsingVarnish" rel="nofollow">Using Varnish</a>.</p><h3 id="HTTPCache-Purging">Purging</h3><p>While purging on content, updates are handled for you; on actions against the eZ Platform APIs, there are times you might have to purge manually.</p><h4 id="HTTPCache-Manualbycode">Manual by code</h4><p>Manual purging from code which takes <a href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache#HTTPCache-SmartHTTPcacheclearing" rel="nofollow">Smart HTTP cache clearing</a> logic into account, this is using the service also used internally for cache clearing on content updates:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>php</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>// Purging cache based on content id, this will trigger cache clear of all locations found by Smart HttpCache clear
// typically self, parent, related, ..
$container-&gt;get('ezpublish.http_cache.purger')-&gt;purgeForContent(55);</pre></td></tr></tbody></table><h4 id="HTTPCache-ManuallybycommandwithSymfonyProxy"><span style="color: rgb(0,98,147);">Manually by command with Symfony Proxy</span></h4><p>Symfony Proxy stores its cache in the Symfony cache directory, so a regular <code>cache:clear</code> commands will clear it:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>bash</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>php app/console --env=prod cache:clear</pre></td></tr></tbody></table><h4 id="HTTPCache-ManualbyHTTPBANrequestonVarnish">Manual by HTTP BAN request on Varnish</h4><p>When using Varnish and in need to purge content directly, then the following examples show how this is done internally by our <span>FOSPurgeClient, and in turn </span>FOSHttpCache Varnish proxy client:</p><p>For purging all:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>bash</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>BAN / HTTP 1.1 
Host: localhost 
X-Location-Id: .* </pre></td></tr></tbody></table><p>Or with given location ids <em>(here 123 and 234)</em>:<span style="color: rgb(0,128,0);"> </span></p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>bash</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>BAN / HTTP 1.1 
Host: localhost 
X-Location-Id: ^(123|234)$</pre></td></tr></tbody></table><pre><span style="color: rgb(0,128,0);"> </span></pre><h2 id="HTTPCache-UsingVarnish">Using Varnish</h2><p>eZ Platform being built on top of Symfony, it uses standard HTTP cache headers. By default the Symfony reverse proxy, written in PHP, is used to handle cache, but it can be easily replaced with any other reverse proxy like Varnish.</p><p><em>Use of Varnish is a requirement for use in Clustering setup, for overview of clustering feature see <a href="https://doc.ez.no/pages/viewpage.action?pageId=31430387">Clustering</a>. </em></p><p> </p><h3 id="HTTPCache-Prerequisites">Prerequisites</h3><ul class="task-list"><li>A working Varnish 3 or Varnish 4 setup.</li></ul><h3 id="HTTPCache-RecommendedVCLbasefiles">Recommended VCL base files</h3><p>For Varnish to work properly with eZ, you'll need to use one of the provided files as a basis:</p><ul class="task-list"><li><a href="https://github.com/ezsystems/ezplatform/blob/master/doc/varnish/vcl/varnish3.vcl" class="external-link" rel="nofollow">Varnish 3 VCL example</a></li><li><a href="https://github.com/ezsystems/ezplatform/blob/master/doc/varnish/vcl/varnish4.vcl" class="external-link" rel="nofollow">Varnish 4 VCL example</a></li></ul><blockquote><p><strong>Note:</strong> Http cache management is done with the help of <a href="http://foshttpcachebundle.readthedocs.org/" class="external-link" rel="nofollow">FOSHttpCacheBundle</a>. You may need to tweak your VCL further on according to <a href="http://foshttpcache.readthedocs.org/en/latest/varnish-configuration.html" class="external-link" rel="nofollow">FOSHttpCache documentation</a> in order to use features supported by it.</p></blockquote><h3 id="HTTPCache-ConfigureeZPublish">Configure eZ Publish</h3><h4 id="HTTPCache-UpdateyourVirtualHost">Update your Virtual Host</h4><p>Somehow we need to tell php process that we are behind a Varnish proxy and not the built in Symfony Http Proxy. If you use fastcgi/fpm you can pass these directly to php process, but you can in all cases also specify them in your web server config.</p><h4 id="HTTPCache-Onapache:">On apache:</h4><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>none</td></tr><tr><th>title</th><td>my_virtualhost.conf</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>&lt;VirthualHost *:80&gt;
    # Configure your VirtualHost with rewrite rules and stuff
 
    # Force front controller NOT to use built-in reverse proxy.
    SetEnv SYMFONY_HTTP_CACHE 0
 
	# Configure IP of your Varnish server to be trusted proxy
    # Replace fake IP address below by your Varnish IP address
    SetEnv SYMFONY_TRUSTED_PROXIES "193.22.44.22"
&lt;/VirtualHost&gt;</pre></td></tr></tbody></table><h4 id="HTTPCache-Onnginx:">On nginx:</h4><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>mysite.com</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>fastcgi_param SYMFONY_HTTP_CACHE 0;
# Configure IP of your Varnish server to be trusted proxy
# Replace fake IP address below by your Varnish IP address
fastcgi_param SYMFONY_TRUSTED_PROXIES "193.22.44.22";</pre></td></tr></tbody></table><h3 id="HTTPCache-UpdateYMLconfiguration">Update YML configuration</h3><p>Secondly we need to tell eZ Platform to change to use http based purge client <em>(specifically FosHttpCache Varnish purge client is used)</em>, and specify url Varnish can be reached on:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>ezplatform.yml</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>ezpublish:
    http_cache:
        purge_type: http
 
    system:
        # Assuming that my_siteaccess_group your frontend AND backend siteaccesses
        my_siteaccess_group:
            http_cache:
                # Fill in your Varnish server(s) address(es).
                purge_servers: [http://my.varnish.server:8081]</pre></td></tr></tbody></table><p> </p><h1 id="HTTPCache-Usage">Usage</h1><h2 id="HTTPCache-Content-awareHTTPCacheContext-awareHTTPcache"><table class="diff-macro bodyless"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/anchor.png);"> </span>Anchor</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th /><td>Content-awareHTTPCache</td></tr><tr><th /><td>Content-awareHTTPCache</td></tr></tbody></table></td></tr></tbody></table>Context-aware HTTP cache</h2><h3 id="HTTPCache-Usecase">Use case</h3><p>As it is based on Symfony 2, eZ Platform uses HTTP cache <span class="confluence-link">extended with features like content awareness</span>. However, this cache management is only available for anonymous users due to HTTP restrictions.</p><p>It is of course possible to make HTTP cache vary thanks to the <code>Vary</code> response header, but this header can only be based on one of the request headers (e.g. <code>Accept-Encoding</code>). Thus, to make the cache vary on a specific context <em>(for example a hash based on a user roles and limitations)</em>, this context must be present in the original request.</p><h3 id="HTTPCache-Feature">Feature</h3><p>As the response can vary on a request header, the base solution is to make the kernel do a sub-request in order to retrieve the user context hash (aka <strong>user hash</strong>). Once the <em>user hash</em> has been retrieved, it's injected in the original request in the <code>X-User-Hash</code> custom header, making it possible to <em>vary</em> the HTTP response on this header:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>php</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>&lt;?php
use Symfony\Component\HttpFoundation\Response;

// ...

// Inside a controller action
$response = new Response();
$response-&gt;setVary('X-User-Hash');</pre></td></tr></tbody></table><p>This solution is implemented in Symfony reverse proxy (aka <em>HttpCache</em>) and is also accessible to dedicated reverse proxies like Varnish.</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/note.png);"> </span>Note</th></tr></thead><tbody><tr><td class="diff-macro-body"><p>Note that sharing ESIs across SiteAccesses is not possible by design (see <table class="diff-macro bodyless"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=jira);"> </span>JIRA</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>server</th><td>eZ Systems JIRA tracker</td></tr><tr><th>serverId</th><td>841cf523-cc54-30bc-bc5d-89e63192498a</td></tr><tr><th>key</th><td>EZP-22535</td></tr></tbody></table></td></tr></tbody></table> for technical details)</p></td></tr></tbody></table><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/tip.png);"> </span>Tip</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>title</th><td>Vary by User</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><p>In cases where you need to deliver content uniquely to a given user, and tricks like using JavaScript and cookie values, hinclude, or disabling cache is not an option. Then remaining option is to vary response by cookie:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>php</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>$response-&gt;setVary('Cookie');</pre></td></tr></tbody></table><p>Unfortunately this is not optimal as it will by default vary by all cookies, including those set by add trackers, analytics tools, recommendation services, etc. However, as long as <em>your</em> application backend does not need these cookies, you can solve this by stripping everything but the session cookie. Example for Varnish can be found in the default VCL examples in part dealing with User Hash, for single-server setup this can easily be accomplished in Apache / Nginx as well.</p></td></tr></tbody></table><p> </p><h3 id="HTTPCache-HTTPcacheclear">HTTP cache clear</h3><p>As eZ Platform uses <a href="http://foshttpcachebundle.readthedocs.org/" class="external-link" rel="nofollow">FOSHttpCacheBundle</a>, this impacts the following features:</p><ul class="task-list"><li>HTTP cache purge</li><li>User context hash</li></ul><p>Varnish proxy client from FOSHttpCache lib is used for clearing eZ HTTP cache, even when using Symfony HttpCache. A single <code>BAN</code> request is sent to registered purge servers, containing a <code>X-Location-Id</code> header. This header contains all Location IDs for which objects in cache need to be cleared.</p><h3 id="HTTPCache-Symfonyreverseproxy">Symfony reverse proxy</h3><p>Symfony reverse proxy (aka HttpCache) is supported out of the box, all you have to do is to activate it.</p><h3 id="HTTPCache-Varnish">Varnish</h3><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/info.png);"> </span>Info</th></tr></thead><tbody><tr><td class="diff-macro-body">Please refer to <a href="https://doc.ez.no/display/DEVELOPER/HTTP+Cache#HTTPCache-UsingVarnish" rel="nofollow">Using Varnish</a></td></tr></tbody></table><h3 id="HTTPCache-Usercontexthash">User context hash</h3><p><a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/user-context.html" class="external-link" rel="nofollow">FOSHttpCacheBundle <em>User Context feature</em></a> is activated by default.</p><p>As the response can vary on a request header, the base solution is to make the kernel do a sub-request in order to retrieve the context (aka <strong>user context hash</strong>). Once the <em>user hash</em> has been retrieved, it's injected in the original request in the <code>X-User-Hash</code> header, making it possible to <em>vary</em> the HTTP response on this header:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/info.png);"> </span>Info</th></tr></thead><tbody><tr><td class="diff-macro-body">Name of the <a href="http://foshttpcachebundle.readthedocs.org/en/latest/reference/configuration/user-context.html" class="external-link" rel="nofollow">user hash header is configurable in FOSHttpCacheBundle</a>. By default eZ Platform sets it to <code>**X-User-Hash**</code>.</td></tr></tbody></table><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>php</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>&lt;?php 
use Symfony\Component\HttpFoundation\Response;
 
// ...
 
// Inside a controller action
$response = new Response();
$response-&gt;setVary('X-User-Hash');

</pre></td></tr></tbody></table><p> </p><p>This solution is <a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/symfony-http-cache.html" class="external-link" rel="nofollow">implemented in Symfony reverse proxy (aka <em>HttpCache</em>)</a> and is also accessible to <a href="http://foshttpcache.readthedocs.org/en/latest/varnish-configuration.html" class="external-link" rel="nofollow">dedicated reverse proxies like Varnish</a>.</p><h3 id="HTTPCache-Workflow">Workflow</h3><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/tip.png);"> </span>Tip</th></tr></thead><tbody><tr><td class="diff-macro-body">Please refer to <a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/user-context.html#how-it-works" class="external-link" rel="nofollow">FOSHttpCacheBundle documentation on how user context feature works</a>.</td></tr></tbody></table><h3 id="HTTPCache-Userhashgeneration">User hash generation</h3><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/tip.png);"> </span>Tip</th></tr></thead><tbody><tr><td class="diff-macro-body">Please refer to <a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/user-context.html#generating-hashes" class="external-link" rel="nofollow">FOSHttpCacheBundle documentation on how user hashes are being generated</a>.</td></tr></tbody></table><p>eZ Platform already interferes with the hash generation process by adding current user permissions and limitations. You can also interfere in this process by <a href="http://foshttpcachebundle.readthedocs.org/en/latest/reference/configuration/user-context.html#custom-context-providers" class="external-link" rel="nofollow">implementing custom context provider(s)</a>.</p><h4 id="HTTPCache-UserhashgenerationwithVarnish3">User hash generation with Varnish 3</h4><p>The behavior described here comes out of the box with Symfony reverse proxy, but it's of course possible to use Varnish to achieve the same.</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>bash</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre># Varnish 3 style for eZ Platform
# Our Backend - We assume that eZ Platform Web server listen on port 80 on the same machine.
backend ezplatform {
    .host = "127.0.0.1";
    .port = "80";
}

# Called at the beginning of a request, after the complete request has been received
sub vcl_recv {

    # Set the backend
    set req.backend = ezplatform;

    # ...

    # Retrieve client user hash and add it to the forwarded request.
    call ez_user_hash;

    # If it passes all these tests, do a lookup anyway;
    return (lookup);
}

# Sub-routine to get client user hash, for context-aware HTTP cache.
# Don't forget to correctly set the backend host for the Curl sub-request.
sub ez_user_hash {

    # Prevent tampering attacks on the hash mechanism
    if (req.restarts == 0
        &amp;&amp; (req.http.accept ~ "application/vnd.fos.user-context-hash"
            || req.http.x-user-context-hash
        )
    ) {
        error 400;
    }

    if (req.restarts == 0 &amp;&amp; (req.request == "GET" || req.request == "HEAD")) {
        # Get User (Context) hash, for varying cache by what user has access to.
        # https://doc.ez.no/display/EZP/Context+aware+HTTP+cach

        # Anonymous user w/o session =&gt; Use hardcoded anonymous hash to avoid backend lookup for hash
        if (req.http.Cookie !~ "eZSESSID" &amp;&amp; !req.http.authorization) {
            # You may update this hash with the actual one for anonymous user
            # to get a better cache hit ratio across anonymous users.
            # Note: Then needs update every time anonymous user role assignments change.
            set req.http.X-User-Hash = "38015b703d82206ebc01d17a39c727e5";
        }
        # Pre-authenticate request to get shared cache, even when authenticated
        else {
            set req.http.x-fos-original-url    = req.url;
            set req.http.x-fos-original-accept = req.http.accept;
            set req.http.x-fos-original-cookie = req.http.cookie;
            # Clean up cookie for the hash request to only keep session cookie, as hash cache will vary on cookie.
            set req.http.cookie = ";" + req.http.cookie;
            set req.http.cookie = regsuball(req.http.cookie, "; +", ";");
            set req.http.cookie = regsuball(req.http.cookie, ";(eZSESSID[^=]*)=", "; \1=");
            set req.http.cookie = regsuball(req.http.cookie, ";[^ ][^;]*", "");
            set req.http.cookie = regsuball(req.http.cookie, "^[; ]+|[; ]+$", "");

            set req.http.accept = "application/vnd.fos.user-context-hash";
            set req.url = "/_fos_user_context_hash";

            # Force the lookup, the backend must tell not to cache or vary on all
            # headers that are used to build the hash.

            return (lookup);
        }
    }

    # Rebuild the original request which now has the hash.
    if (req.restarts &gt; 0
        &amp;&amp; req.http.accept == "application/vnd.fos.user-context-hash"
    ) {
        set req.url         = req.http.x-fos-original-url;
        set req.http.accept = req.http.x-fos-original-accept;
        set req.http.cookie = req.http.x-fos-original-cookie;

        unset req.http.x-fos-original-url;
        unset req.http.x-fos-original-accept;
        unset req.http.x-fos-original-cookie;

        # Force the lookup, the backend must tell not to cache or vary on the
        # user hash to properly separate cached data.

        return (lookup);
    }
}

sub vcl_fetch {

    # ...

    if (req.restarts == 0
        &amp;&amp; req.http.accept ~ "application/vnd.fos.user-context-hash"
        &amp;&amp; beresp.status &gt;= 500
    ) {
        error 503 "Hash error";
    }
}

sub vcl_deliver {
    # On receiving the hash response, copy the hash header to the original
    # request and restart.
    if (req.restarts == 0
        &amp;&amp; resp.http.content-type ~ "application/vnd.fos.user-context-hash"
        &amp;&amp; resp.status == 200
    ) {
        set req.http.x-user-hash = resp.http.x-user-hash;

        return (restart);
    }

    # If we get here, this is a real response that gets sent to the client.

    # Remove the vary on context user hash, this is nothing public. Keep all
    # other vary headers.
    set resp.http.Vary = regsub(resp.http.Vary, "(?i),? *x-user-hash *", "");
    set resp.http.Vary = regsub(resp.http.Vary, "^, *", "");
    if (resp.http.Vary == "") {
        remove resp.http.Vary;
    }

    # Sanity check to prevent ever exposing the hash to a client.
    remove resp.http.x-user-hash;
}
</pre></td></tr></tbody></table><h4 id="HTTPCache-UserhashgenerationwithVarnish4">User hash generation with Varnish 4</h4><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-body"><pre>// Varnish 4 style for eZ Platform
// Complete VCL example

vcl 4.0;

// Our Backend - Assuming that web server is listening on port 80
// Replace the host to fit your setup
backend ezplatform {
    .host = "127.0.0.1";
    .port = "80";
}

// Called at the beginning of a request, after the complete request has been received
sub vcl_recv {

    // Set the backend
    set req.backend_hint = ezplatform;

    // ...

    // Retrieve client user hash and add it to the forwarded request.
    call ez_user_hash;

    // If it passes all these tests, do a lookup anyway.
    return (hash);
}
 
// Called when the requested object has been retrieved from the backend
sub vcl_backend_response {
    if (bereq.http.accept ~ "application/vnd.fos.user-context-hash"
        &amp;&amp; beresp.status &gt;= 500
    ) {
        return (abandon);
    }
    
    // ...
}

// Sub-routine to get client user hash, for context-aware HTTP cache.
sub ez_user_hash {

    // Prevent tampering attacks on the hash mechanism
    if (req.restarts == 0
        &amp;&amp; (req.http.accept ~ "application/vnd.fos.user-context-hash"
            || req.http.x-user-hash
        )
    ) {
        return (synth(400));
    }

    if (req.restarts == 0 &amp;&amp; (req.method == "GET" || req.method == "HEAD")) {
        // Get User (Context) hash, for varying cache by what user has access to.
        // https://doc.ez.no/display/EZP/Context+aware+HTTP+cache

        // Anonymous user w/o session =&gt; Use hardcoded anonymous hash to avoid backend lookup for hash
        if (req.http.Cookie !~ "eZSESSID" &amp;&amp; !req.http.authorization) {
            // You may update this hash with the actual one for anonymous user
            // to get a better cache hit ratio across anonymous users.
            // Note: You should then update it every time anonymous user rights change.
            set req.http.X-User-Hash = "38015b703d82206ebc01d17a39c727e5";
        }
        // Pre-authenticate request to get shared cache, even when authenticated
        else {
            set req.http.x-fos-original-url    = req.url;
            set req.http.x-fos-original-accept = req.http.accept;
            set req.http.x-fos-original-cookie = req.http.cookie;
            // Clean up cookie for the hash request to only keep session cookie, as hash cache will vary on cookie.
            set req.http.cookie = ";" + req.http.cookie;
            set req.http.cookie = regsuball(req.http.cookie, "; +", ";");
            set req.http.cookie = regsuball(req.http.cookie, ";(eZSESSID[^=]*)=", "; \1=");
            set req.http.cookie = regsuball(req.http.cookie, ";[^ ][^;]*", "");
            set req.http.cookie = regsuball(req.http.cookie, "^[; ]+|[; ]+$", "");
            set req.http.accept = "application/vnd.fos.user-context-hash";
            set req.url = "/_fos_user_context_hash";

            // Force the lookup, the backend must tell how to cache/vary response containing the user hash
            return (hash);
        }
    }

    // Rebuild the original request which now has the hash.
    if (req.restarts &gt; 0
        &amp;&amp; req.http.accept == "application/vnd.fos.user-context-hash"
    ) {
        set req.url         = req.http.x-fos-original-url;
        set req.http.accept = req.http.x-fos-original-accept;
        set req.http.cookie = req.http.x-fos-original-cookie;
        unset req.http.x-fos-original-url;
        unset req.http.x-fos-original-accept;
        unset req.http.x-fos-original-cookie;

        // Force the lookup, the backend must tell not to cache or vary on the
        // user hash to properly separate cached data.

        return (hash);
    }
}

sub vcl_deliver {
    // On receiving the hash response, copy the hash header to the original
    // request and restart.
    if (req.restarts == 0
        &amp;&amp; resp.http.content-type ~ "application/vnd.fos.user-context-hash"
    ) {
        set req.http.x-user-hash = resp.http.x-user-hash;
        return (restart);
    }

    // If we get here, this is a real response that gets sent to the client.
    // Remove the vary on context user hash, this is nothing public. Keep all
    // other vary headers.
    set resp.http.Vary = regsub(resp.http.Vary, "(?i),? *x-user-hash *", "");
    set resp.http.Vary = regsub(resp.http.Vary, "^, *", "");
    if (resp.http.Vary == "") {
        unset resp.http.Vary;
    }

    // Sanity check to prevent ever exposing the hash to a client.
    unset resp.http.x-user-hash;
    if (client.ip ~ debuggers) {
        if (obj.hits &gt; 0) {
            set resp.http.X-Cache = "HIT";
            set resp.http.X-Cache-Hits = obj.hits;
        } else {
            set resp.http.X-Cache = "MISS";
        }
    }
}</pre></td></tr></tbody></table><h4 id="HTTPCache-NewanonymousX-User-Hash">New anonymous X-User-Hash</h4><p>The anonymous X-User-Hash is generated based on the <em>anonymous user</em>, <em>group</em> and <em>role</em>. The <code>38015b703d82206ebc01d17a39c727e5</code> hash that is provided in the code above will work only when these three variables are left unchanged. Once you change the default permissions and settings, the X-User-Hash will change and Varnish won't be able to effectively handle cache anymore.</p><p>In that case you need to find out the new anonymous X-User-Hash and change the VCL accordingly, else Varnish will return a no-cache header.</p><p>The easiest way to find the new hash is:</p><p><strong>1.</strong> Connect to your server (<em>shh</em> should be enough)</p><p><strong>2.</strong> Add <code>&lt;<a href="http://your-domain.com/" class="external-link" rel="nofollow">your-domain.com</a>&gt;</code> to your <code>/etc/hosts</code> file</p><p><strong>3.</strong> Execute the following command:</p><p><code>curl -I -H "Accept: application/vnd.fos.user-context-hash" http://&lt;<a href="http://your-domain.com/" class="external-link" rel="nofollow">your-domain.com</a>&gt;/_fos_user_context_hash</code></p><p>You should get a result like this:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-body"><pre>HTTP/1.1 200 OK
Date: Mon, 03 Oct 2016 15:34:08 GMT
Server: Apache/2.4.18 (Ubuntu)
X-Powered-By: PHP/7.0.8-0ubuntu0.16.04.2
X-User-Hash: b1731d46b0e7a375a5b024e950fdb8d49dd25af85a5c7dd5116ad2a18cda82cb
Cache-Control: max-age=600, public
Vary: Cookie,Authorization
Content-Type: application/vnd.fos.user-context-hash</pre></td></tr></tbody></table><p><strong>4.</strong> Now, replace the existing X-User-Hash value with the new one:</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-body"><pre># Note: This needs update every time anonymous user role assignments change.
set req.http.X-User-Hash = "b1731d46b0e7a375a5b024e950fdb8d49dd25af85a5c7dd5116ad2a18cda82cb";</pre></td></tr></tbody></table><p><strong>5.</strong> Restart the Varnish server and everything should work fine.</p><h4 id="HTTPCache-DefaultoptionsforFOSHttpCacheBundledefinedineZ">Default options for FOSHttpCacheBundle defined in eZ</h4><p>The following configuration is defined in eZ by default for FOSHttpCacheBundle. You may override these settings.</p><table class="diff-macro"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/plugins/servlet/confluence/placeholder/macro-icon?name=code);"> </span>Code Block</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>language</th><td>bash</td></tr></tbody></table></td></tr></tbody><tbody><tr><td class="diff-macro-body"><pre>fos_http_cache: 
    proxy_client: 
        # "varnish" is used, even when using Symfony HttpCache.
        default: varnish
        varnish: 
            # Means http_cache.purge_servers defined for current SiteAccess.
            servers: [$http_cache.purge_servers$]

    user_context: 
        enabled: true
        # User context hash is cached during 10min
        hash_cache_ttl: 600
        user_hash_header: X-User-Hash</pre></td></tr></tbody></table><p><span> </span></p><div class="highlight highlight-yaml"><h3 id="HTTPCache-Credits">Credits</h3><p>This feature is based on <a href="http://asm89.github.io/2012/09/26/context-aware-http-caching.html" class="external-link" rel="nofollow">Context aware HTTP caching post</a> by <a href="https://github.com/asm89" class="external-link" rel="nofollow">asm89</a>.</p></div></div></div><div class="cell aside" data-type="aside"><div class="innerCell"><h4 id="HTTPCache-Inthistopic:">In this topic:</h4><p><table class="diff-macro bodyless"><thead><tr><th class="diff-macro-title"><span class="icon macro-placeholder-icon" style="background-image: url(https://doc.ez.no/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/macrobrowser/dropdown/toc.png);"> </span>Table of Contents</th></tr></thead><tbody><tr><td class="diff-macro-properties"><table><tbody><tr><th>maxLevel</th><td>3</td></tr></tbody></table></td></tr></tbody></table></p><h4 id="HTTPCache-Related:"><span class="diff-html-added" id="added-diff-0">Related:</span></h4><ul><li><a href="https://doc.ez.no/pages/viewpage.action?pageId=31432321"><span class="diff-html-added">Overview of steps to set up Cluster</span></a><a href="https://doc.ez.no/pages/viewpage.action?pageId=31430152"><span class="diff-html-added">:</span></a><ul><li><a href="https://doc.ez.no/pages/viewpage.action?pageId=31430387"><span class="diff-html-added">Set up DFS IO Handler</span></a></li><li><a href="https://doc.ez.no/pages/viewpage.action?pageId=31432023"><span class="diff-html-added">Configure Persistence Cache</span></a></li><li><span class="confluence-link"><a href="https://doc.ez.no/pages/viewpage.action?pageId=31429667"><span class="diff-html-added">Configure sessions</span></a></span></li></ul></li></ul></div></div></div></div>
</div>
    
    

            
</div>


    




    
    

    
    
    







</div>
  
        <div id="theme-footer">
            <p>© 1999-2016 <a href="http://ez.no/" class="external-link" rel="nofollow">eZ Systems AS</a> and others</p>
        </div>
    
    </div>
</div>


        
            
            

<div id="footer" role="contentinfo">
    <section class="footer-body">

                                                            <p class="license license-opensource">
                    Powered by a free <b>Atlassian Confluence Open Source Project License</b> granted to eZ Publish. <a href="http://www.atlassian.com/c/conf/11461">Evaluate Confluence today</a>.<br>
                </p>
                    
        

        <ul id="poweredby">
            <li class="noprint">Powered by <a href="http://www.atlassian.com/software/confluence" class="hover-footer-link">Atlassian Confluence</a> <span id='footer-build-information'>5.8.5</span>, <a href="http://www.atlassian.com/software/confluence/overview/team-collaboration-software?utm_source=confluence-footer" class="hover-footer-link">Team Collaboration Software</a></li>
            <li class="print-only">Printed by Atlassian Confluence 5.8.5, Team Collaboration Software.</li>
            <li class="noprint"><a href="https://jira.atlassian.com/browse/CONF" class="hover-footer-link">Report a bug</a></li>
            <li class="noprint"><a href="http://www.atlassian.com/about/connected.jsp?s_kwcid=Confluence-stayintouch" class="hover-footer-link">Atlassian News</a></li>
        </ul>

        

        <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>

                    <script>
AJS.toInit(function(){
 if(AJS.params.spaceKey &&
    AJS.params.spaceKey === 'MAIN' ||
    AJS.params.spaceKey === 'EZMA' ||
    AJS.params.spaceKey === 'ODC' ||
    AJS.params.spaceKey === 'EZP50' ||
    AJS.params.spaceKey === 'EZP51' ||
    AJS.params.spaceKey === 'EZP52' ||
    AJS.params.spaceKey === 'EZPCLOUD' ||
    AJS.params.spaceKey === 'EZP' ||
    AJS.params.spaceKey === 'TECHDOC' ||
    AJS.params.spaceKey === 'USERGUIDE' ||
    AJS.params.spaceKey === 'EZRECO'
){

(function()
{var isSecure=('https:'==document.location.protocol);var ff=document.createElement('script');ff.type='text/javascript';ff.async=true;ff.src=(isSecure?'https':'http')+'://'+(isSecure?'secure.':'lb.')+'liveviewer.ez.no/statjs/sst-120-1304513615/stat.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ff,s);}
)();

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-303624-13', 'ez.no');
  ga('send', 'pageview');
}}
);
</script>
        
    </section>
</div>

    </div>
</body>

<!-- Mirrored from doc.ez.no/pages/diffpagesbyversion.action?pageId=31430152&selectedPageVersions=21&selectedPageVersions=22 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 09:37:54 GMT -->
</html>
