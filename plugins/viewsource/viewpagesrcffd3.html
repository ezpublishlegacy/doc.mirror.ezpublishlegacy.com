                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    
<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=12125301 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 21 Oct 2014 12:52:11 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
        <title>View Source</title>
        <link rel="canonical" href="../../pages/viewpageffd3.html?pageId=12125301" />
        <link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch934e.css?media=print" media="print">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 8]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+8" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/1f2a9c4c7f2593422cc9b02d1a652a22/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/70f6d025b64de5008ccd042576cd8d90/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/70f6d025b64de5008ccd042576cd8d90/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/26ac2724af3c6ece1051365650d982fa/_/download/contextbatch/css/editor-content/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/1.3/_/download/batch/com.atlassian.confluence.plugins.confluence-hig/com.atlassian.confluence.plugins.confluence-highlight-ac" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/1.3/_/download/batch/com.atlassian.confluence.plugins.confluence-highlight-actions:highlighting-experiment-resources/com.atlassian.confluence.plugins.confluence-highlight-actions:highlighting-experiment-resources.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/16/_/styles/colors556c.css?spaceKey=EZP51" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/16/_/styles/custom556c.css?spaceKey=EZP51" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <table class="wysiwyg-macro" data-macro-name="info" style="background-image: url(../servlet/confluence/placeholder/macro-headingd35c.png?definition=e2luZm99&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body">Persistence cache is a new feature introduced in 5.1. It does not exists in previous versions.</td></tr></table><p><img class="editor-inline-macro" src="../servlet/confluence/placeholder/macro4170.png?definition=e3RvY30&amp;locale=en_GB&amp;version=2" data-macro-name="toc"></p><h1>Introduction</h1><p> </p><p>This page describes how Persistence cache works, and how to reuse the cache service it uses.</p><p><strong>Configuration</strong></p><p>For configuring the cache service, look at the <a class="confluence-link" href="../../display/EZP51/Persistence%2bcache%2bconfiguration.html" data-linked-resource-id="14123049" data-linked-resource-type="page" data-linked-resource-default-alias="Persistence cache configuration" data-base-url="../../index.html">Persistence cache configuration</a> page.</p><h1>Persistent cache</h1><p><img class="confluence-embedded-image image-left" src="../../download/attachments/10158280/SPI%20Cachea59a.png?version=2&amp;modificationDate=1370128139000&amp;api=v2" data-image-src="/download/attachments/10158280/SPI%20Cache.png?version=2&amp;modificationDate=1370128139000&amp;api=v2" data-linked-resource-id="13107679" data-linked-resource-type="attachment" data-linked-resource-default-alias="SPI Cache.png" data-base-url="https://doc.ez.no" data-linked-resource-container-id="10158280" title="eZ Publish Platform 5.x > Persistence cache > SPI Cache.png" data-location="eZ Publish Platform 5.x > Persistence cache > SPI Cache.png"></p><h4>Layers</h4><p>Persistence cache can best be described as a implementation of SPI\Persistence that wraps around the main implementation (currently: &quot;Legacy Storage Engine&quot;).</p><p>As shown in the illustration this is done in the exact same way as the SignalSlot feature is a custom implementation of API\Repository wraps around the main Repository. In the case of Persistence Cache, instead of sending events on calls passed on to the wrapped implementation, most of the load calls are cached, and calls that perform changes purges the affected caches. This is done using a Cache service which is provided by StashBundle; this Service wraps around the Stash library to provide Symfony logging / debugging functionality, and allows configuration on cache handlers (Memcached, Apc, Filesystem, ..) to be configured using Symfony configuration. For how to reuse this Cache service in your own custom code, see below.</p><h4>Transparent cache</h4><p>The persistence cache, just like the HTTP cache, tries to follow principles of &quot;Transparent caching&quot;, this can shortly be described as a cache which is invisible to the end user and to the admin/editors of eZ Publish where content is always returned &quot;fresh&quot;. In other words there should not be a need to manually clear the cache like was frequently the case with eZ Publish 4.x (aka &quot;legacy&quot;). This is possible thanks to an interface that follows CRUD (Create Read Update Delete) operations per domain, and number of other operations capable of affecting a certain domain is kept to a minimum.</p><p> </p><h5>Entity stored only once</h5><p>To make the transparent caching principle as effective as possible, entities are as much as possible only stored once in cache by their primary id. Lookup by a<span><span>lternative identifiers (identifier, remoteId, ..) is only cached with the identifier as cache key and primary id as it's cache value, and </span></span>compositions<span><span> (list of objects) usually keep only the array of primary id's as their cache value.</span></span></p><p><span>This means a couple of things:</span></p><ul><li><span>Memory consumption is kept low</span></li><li>Cache purging logic is kept simple ( Example: $sectionService-&gt;delete( 3 ) clears &quot;section/3&quot; cache entry )</li><li>Lookup by identifier and list of objects needs several cache lookups to be able to assemble the result value</li><li>Cache warmup usually takes several page loads to reach full as identifier is first cached, then the object</li></ul><h4>What is cached?</h4><p>Persistence cache aimed in its first iteration for caching all SPI\Persistence calls used in a normal page load, including everything needed for permission checking and url alias lookups.<br />However Search queries are currently not cached as it is more difficult to make sure they stay fresh unless all search cache is purged on every modification, or a complicated search cache walking purge system is implemented that is able to detect which search result to clear (this is what is planned for future versions, but it is planned to be done when there is a background process system in place).</p><p>Anyway, the following SPI calls are not currently cached:</p><ul><li>ObjectStateHandler</li><li>TrashHandler</li><li>UrlWildCardHandler</li><li>SearchHandler::*</li><li>transactions</li></ul><p>For more details on which calls are cached or not, and where to contribute additional caches, check out the <a href="https://github.com/ezsystems/ezpublish-kernel/tree/master/eZ/Publish/Core/Persistence/Cache">source</a>.</p><h4>Legacy kernel cache purging</h4><p>Currently with the Dual-kernel eZ Publish has in version 5.x, the &quot;Transparent caching principle&quot; referred to above has one major obstacle. eZ Publish 4.x (&quot;legacy&quot;) kernel was not made for such a thing and has a lot of API's that can make changes to the data in the database and hence make the persistence cache &quot;stale&quot; (aka out of date).</p><p>A couple of things are in place to try to avoid this from happening / making it less of a problem:</p><ul><li>The Persistence cache has a expiry time configurable in ezpublish.yml</li><li>LegacyBundle (the bundle that exposes legacy to Symfony and integrates Symfony with legacy) has a PersistenceCachePurger</li></ul><h5>PersistenceCachePurger</h5><p><a href="https://github.com/ezsystems/ezpublish-kernel/blob/master/eZ/Bundle/EzPublishLegacyBundle/Cache/PersistenceCachePurger.php">PersistenceCachePurger</a> is setup by LegacyBundle to receive all relevant <a href="https://github.com/ezsystems/ezpublish-legacy/blob/master/doc/features/5.0/event.txt">cache</a> <a href="https://github.com/ezsystems/ezpublish-legacy/blob/master/doc/features/5.1/event.txt">events</a> triggered by legacy kernel, and clear relevant Persistence cache based on the incoming data.<br />This means a &quot;Clear all cache&quot; operation done in legacy will also clear all persistence cache, it also means relevant content cache is cleared on publishing, so all code using the api's covered by these events should in effect be cache safe in regards to persistence cache.</p><p>So, in case of stale persistence cache, a clear all cache in legacy admin interface is thus still possible, however a manual cache clear is also possible but how to do it depends on which cache handler is currently used. </p><h1>Reusing Cache service</h1><p>Using the cache service allows you to use a interface  and not have to care about if the system has been configured to place the cache in Memcached, Apc or on File system. And as eZ Publish requries that instances uses a cluster aware cache, you can safly assume your cache is shared across all eZ Publish web servers.</p><table class="wysiwyg-macro" data-macro-name="warning" data-macro-parameters="title=Interface warning" style="background-image: url(../servlet/confluence/placeholder/macro-heading61eb.png?definition=e3dhcm5pbmc6dGl0bGU9SW50ZXJmYWNlIHdhcm5pbmd9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>Current implementation uses a caching library called <a class="external-link" href="http://stash.tedivm.com/" rel="nofollow">Stash</a>, via <a class="external-link" href="https://github.com/tedivm/TedivmStashBundle" rel="nofollow">Stash-bundle</a>. If this changes, then the Interface of the cache service will most likely change as well.</p></td></tr></table><table class="wysiwyg-macro" data-macro-name="warning" data-macro-parameters="title=Cache key warning" style="background-image: url(../servlet/confluence/placeholder/macro-heading206e.png?definition=e3dhcm5pbmc6dGl0bGU9Q2FjaGUga2V5IHdhcm5pbmd9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>When reusing the cache service within your own code, it is very important to not conflict with the cache keys used by eZ Publish, hence why example of usage starts with a unique &quot;myApp&quot; key for the namespace of your own cache, you must do the same!</p><p>Also, this means that when eZ Publish clears all cache, it will also wipe out your custom cache as well!</p></td></tr></table><table class="wysiwyg-macro" data-macro-name="warning" data-macro-parameters="title=Multi site warning" style="background-image: url(../servlet/confluence/placeholder/macro-heading8937.png?definition=e3dhcm5pbmc6dGl0bGU9TXVsdGkgc2l0ZSB3YXJuaW5nfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>Be aware that in some edge cases as of eZ Publish 5.1, we recommend that the cache system is practically disabled using a <em>Blackhole</em> driver. This is the case in multi repository (one eZ Publish install, several databases) because the current configuration does not support setting cache key prefixes pr database (the current configuration is global to installation and not possible to set pr site / site group).</p><p>In this case the cache service will only keep your cache during the request, if the recommended InMemory setting is enabled.</p></td></tr></table><h2>Get Cache service</h2><h3>Via Dependency injection</h3><p>In eZ Publish 5.x Symfony2 stack you can simply define that you require the &quot;cache&quot; service in your configuration like so:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="title=yml configuration" style="background-image: url(../servlet/confluence/placeholder/macro-heading5d0e.png?definition=e2NvZGU6dGl0bGU9eW1sIGNvbmZpZ3VyYXRpb259&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>    myApp.myService:
        class: %myApp.myService.class%
        arguments:
            - @stash.default_cache</pre></td></tr></table><p>The &quot;cache&quot; service is an instance of the following class: Tedivm\StashBundle\Service\CacheService</p><h3>Via Symfony2 Container</h3><p>Like any other service, it is possible to get the &quot;cache&quot; service via container as well like so:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=getting the cache service in php" style="background-image: url(../servlet/confluence/placeholder/macro-heading567e.png?definition=e2NvZGU6dGl0bGU9Z2V0dGluZyB0aGUgY2FjaGUgc2VydmljZSBpbiBwaHB8bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>/** @var $cacheService \Tedivm\StashBundle\Service\CacheService */
$cacheService = $container->get( 'stash.default_cache' );</pre></td></tr></table><h3>In legacy via Symfony2 Container</h3><p>When eZ Publish legacy runs via eZ Publish 5.x Symfony2 stack, you will be able to get the service container in the following way:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=Getting cache service in legacy" style="background-image: url(../servlet/confluence/placeholder/macro-headinga05e.png?definition=e2NvZGU6dGl0bGU9R2V0dGluZyBjYWNoZSBzZXJ2aWNlIGluIGxlZ2FjeXxsYW5ndWFnZT1waHB9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>// From a legacy module or any PHP code running in legacy context.
$container = ezpKernel::instance()->getServiceContainer();
 
/** @var $cacheService \Tedivm\StashBundle\Service\CacheService */
$cacheService = $container->get( 'stash.default_cache' );</pre></td></tr></table><h2>Using the cache service</h2><p>Example usage of the cache service:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=Actuall example from cache use in ezpublish-kernel" style="background-image: url(../servlet/confluence/placeholder/macro-headingce00.png?definition=e2NvZGU6dGl0bGU9QWN0dWFsbCBleGFtcGxlIGZyb20gY2FjaGUgdXNlIGluIGV6cHVibGlzaC1rZXJuZWx8bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>    $cacheItem = $cacheService->getItem( 'myApp', 'object', $id );
    if ( $cacheItem->isMiss() )
    {
        $myObject = $container->get('my_app.backend_service')->loadObject( $id )
        $cacheItem->set( $myObject );
    }
    else
    {
        $myObject = $cacheItem->get();
    }
    return $myObject;</pre></td></tr></table><p><span>For more info on usage, take a look at </span><a href="http://stash.tedivm.com/">Stash's documentation</a><span>.</span></p><p> </p><p> </p><p> </p>
        <p>&nbsp;</p>
    </body>

<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=12125301 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 21 Oct 2014 12:52:11 GMT -->
</html>
