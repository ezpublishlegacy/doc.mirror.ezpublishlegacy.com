                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    
<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=23528522 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 21 Oct 2014 10:09:28 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
        <title>View Source</title>
        <link rel="canonical" href="../../pages/viewpage1786.html?pageId=23528522" />
        <link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch934e.css?media=print" media="print">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 8]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+8" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/73/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/1f2a9c4c7f2593422cc9b02d1a652a22/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/70f6d025b64de5008ccd042576cd8d90/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/70f6d025b64de5008ccd042576cd8d90/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/26ac2724af3c6ece1051365650d982fa/_/download/contextbatch/css/editor-content/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/1.3/_/download/batch/com.atlassian.confluence.plugins.confluence-hig/com.atlassian.confluence.plugins.confluence-highlight-ac" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/1.3/_/download/batch/com.atlassian.confluence.plugins.confluence-highlight-actions:highlighting-experiment-resources/com.atlassian.confluence.plugins.confluence-highlight-actions:highlighting-experiment-resources.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/51/_/styles/colorsb538.css?spaceKey=EZP" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB-1988229788/4733/f235dd088df5682b0560ab6fc66ed22c9124c0be.12/51/_/styles/customb538.css?spaceKey=EZP" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <table class="wysiwyg-macro" data-macro-name="note" data-macro-parameters="title=Version compatibility" style="background-image: url(../servlet/confluence/placeholder/macro-heading77d5.png?definition=e25vdGU6dGl0bGU9VmVyc2lvbiBjb21wYXRpYmlsaXR5fQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>This recipe is compatible with <strong>eZ Publish 5.4 / 2014.07</strong></p></td></tr></table><p><img class="editor-inline-macro" src="../servlet/confluence/placeholder/macro4170.png?definition=e3RvY30&amp;locale=en_GB&amp;version=2" data-macro-name="toc"></p><h2>Description</h2><p>Symfony Config component makes it possible to define <em>semantic configuration</em>, exposed to the end-developer. This configuration is validated by rules you define, e.g. validating type (string, array, integer, boolean...). Usually, once validated and processed this semantic configuration is then mapped to internal <em>key/value</em> parameters stored in the <code>ServiceContainer</code>.</p><p>eZ Publish uses this for its core configuration, but adds another configuration level, the <strong>SiteAccess</strong>. For each defined SiteAccess, we need to be able to use the same configuration tree in order to define SiteAccess specific config. These settings then need to be mapped to SiteAccess aware internal parameters, that one can retrieve via the <code>ConfigResolver</code>. For this, internal keys need to follow the format <code>&lt;namespace&gt;.&lt;scope&gt;.&lt;parameter_name&gt;</code>, <code>namespace</code> being specific to your app/bundle, <code>scope</code> being the SiteAccess, SiteAccess group, <code>default</code> or <code>global</code>, <code>parameter_name</code> being the actual setting <em>identifier</em>.</p><table class="wysiwyg-macro" data-macro-name="info" style="background-image: url(../servlet/confluence/placeholder/macro-headingd35c.png?definition=e2luZm99&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p><span style="color: rgb(0,0,0);">For more information on ConfigResolver, namespaces and scopes, see </span><a class="confluence-link" href="../../display/EZP/Configuration.html" data-linked-resource-id="2720538" data-linked-resource-type="page" data-linked-resource-default-alias="Configuration" data-base-url="../../index.html">eZ Publish configuration basics</a><span style="color: rgb(119,119,119);">.</span></p></td></tr></table><p><span>Goal of this feature is to make it easy to implement a </span><em>SiteAccess aware</em><span> semantic configuration and its mapping to internal config for any eZ bundle developer.</span></p><h2>Semantic configuration parsing</h2><p><span><span>An abstract </span><code>Configuration</code><span> class has been added, simplifying the way to add a SiteAccess settings tree like the following:</span></span></p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash|title=ezpublish.yml or config.yml" style="background-image: url(../servlet/confluence/placeholder/macro-heading0b5a.png?definition=e2NvZGU6dGl0bGU9ZXpwdWJsaXNoLnltbCBvciBjb25maWcueW1sfGxhbmd1YWdlPWJhc2h9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>acme_demo:
    system:
        my_siteaccess:
            hello: "world"
            foo_setting:
                an_integer: 456
                enabled: true

        my_siteaccess_group:
            hello: "universe"
            foo_setting:
                foo: "bar"
                some: "thing"
                an_integer: 123
                enabled: false</pre></td></tr></table><p> </p><p><span>Class FQN is </span><code>eZ\Bundle\EzPublishCoreBundle\DependencyInjection\Configuration\SiteAccessAware\Configuration</code><span>.<br /></span><span style="line-height: 1.4285715;">All you have to do is to extend it and use </span><code style="line-height: 1.4285715;">$this-&gt;generateScopeBaseNode()</code><span style="line-height: 1.4285715;">:</span></p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>namespace Acme\DemoBundle\DependencyInjection;

use eZ\Bundle\EzPublishCoreBundle\DependencyInjection\Configuration\SiteAccessAware\Configuration as SiteAccessConfiguration;
use Symfony\Component\Config\Definition\Builder\NodeBuilder;
use Symfony\Component\Config\Definition\Builder\TreeBuilder;

class Configuration extends SiteAccessConfiguration
{
    public function getConfigTreeBuilder()
    {
        $treeBuilder = new TreeBuilder();
        $rootNode = $treeBuilder->root( 'acme_demo' );

        // $systemNode will then be the root of siteaccess aware settings.
        $systemNode = $this->generateScopeBaseNode( $rootNode );
        $systemNode
            ->scalarNode( 'hello' )->isRequired()->end()
            ->arrayNode( 'foo_setting' )
                ->children()
                    ->scalarNode( "foo" )->end()
                    ->scalarNode( "some" )->end()
                    ->integerNode( "an_integer" )->end()
                    ->booleanNode( "enabled" )->end()
                ->end()
            ->end();

        return $treeBuilder;
    }
}</pre></td></tr></table><table class="wysiwyg-macro" data-macro-name="info" style="background-image: url(../servlet/confluence/placeholder/macro-headingd35c.png?definition=e2luZm99&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p><span style="color: rgb(0,0,0);">Default name for the <em>SiteAccess root node</em> is <code>system</code>, but you can customize it. For this, just pass the name you want to use as a 2nd argument of <code>$this-&gt;generateScopeBaseNode()</code>.</span></p></td></tr></table><h2>Mapping to internal settings</h2><p>Semantic configuration must always be <em>mapped</em> to internal <em>key/value</em> settings within the <code>ServiceContainer</code>. This is usually done in the DIC extension.</p><p>For SiteAccess aware settings, new <code>ConfigurationProcessor</code> and <code>Contextualizer</code> classes have been introduced to ease the process.</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>namespace Acme\DemoBundle\DependencyInjection;

use eZ\Bundle\EzPublishCoreBundle\DependencyInjection\Configuration\SiteAccessAware\ConfigurationProcessor;
use eZ\Bundle\EzPublishCoreBundle\DependencyInjection\Configuration\SiteAccessAware\ContextualizerInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\Config\FileLocator;
use Symfony\Component\HttpKernel\DependencyInjection\Extension;
use Symfony\Component\DependencyInjection\Loader;

/**
 * This is the class that loads and manages your bundle configuration
 *
 * To learn more see {@link http://symfony.com/doc/current/cookbook/bundles/extension.html}
 */
class AcmeDemoExtension extends Extension
{
    public function load( array $configs, ContainerBuilder $container )
    {
        $configuration = $this->getConfiguration( $configs, $container );
        $config = $this->processConfiguration( $configuration, $configs );

        $loader = new Loader\YamlFileLoader( $container, new FileLocator( __DIR__.'/../Resources/config' ) );
        $loader->load( 'default_settings.yml' );

        // "acme_demo" will be the namespace as used in ConfigResolver format.
        $processor = new ConfigurationProcessor( $container, 'acme_demo' );
        $processor->mapConfig(
            $config,
            // Any kind of callable can be used here.
            // It will be called for each declared scope/SiteAccess.
            function ( $scopeSettings, $currentScope, ContextualizerInterface $contextualizer )
            {
                // Will map "hello" setting to "acme_demo.&lt;$currentScope>.hello" container parameter
                // It will then be possible to retrieve this parameter through ConfigResolver in the application code:
                // $helloSetting = $configResolver->getParameter( 'hello', 'acme_demo' );
                $contextualizer->setContextualParameter( 'hello', $currentScope, $scopeSettings['hello'] );
            }
        );

        // Now map "foo_setting" and ensure keys defined for "my_siteaccess" overrides the one for "my_siteaccess_group"
        // It is done outside the closure as it is needed only once.
        $processor->mapConfigArray( 'foo_setting', $config );
    }
}</pre></td></tr></table><table class="wysiwyg-macro" data-macro-name="tip" data-macro-parameters="title=Tip" style="background-image: url(../servlet/confluence/placeholder/macro-heading6668.png?definition=e3RpcDp0aXRsZT1UaXB9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>You can map simple settings by calling <code>$processor-&gt;mapSetting()</code>, without having to call <code>$processor-&gt;mapConfig()</code> with a callable.</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>$processor = new ConfigurationProcessor( $container, 'acme_demo' );
$processor->mapSetting( 'hello', $config );</pre></td></tr></table></td></tr></table><table class="wysiwyg-macro" data-macro-name="warning" style="background-image: url(../servlet/confluence/placeholder/macro-headingca13.png?definition=e3dhcm5pbmd9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p><strong>Important:</strong> Always ensure you have defined and loaded default settings.</p></td></tr></table><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash|title=@AcmeDemoBundle/Resources/config/default_settings.yml" style="background-image: url(../servlet/confluence/placeholder/macro-headingb5ac.png?definition=e2NvZGU6dGl0bGU9QEFjbWVEZW1vQnVuZGxlL1Jlc291cmNlcy9jb25maWcvZGVmYXVsdF9zZXR0aW5ncy55bWx8bGFuZ3VhZ2U9YmFzaH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>parameters:
    acme_demo.default.hello: world
    acme_demo.default.foo_setting:
        foo: ~
        some: ~
        planets: [Earth]
        an_integer: 0
        enabled: false
        j_adore: les_sushis</pre></td></tr></table><h3>Merging hash values between scopes</h3><p>When you define a hash as semantic config, you sometimes don't want the SiteAccess settings to replace the default or group values, but <em>enrich</em> them by appending new entries. This is made possible by using <code>$processor-&gt;mapConfigArray()</code>, which needs to be called outside the closure (before or after), in order to be called only once.</p><p><span>Consider the following default config:</span></p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash|title=default_settings.yml" style="background-image: url(../servlet/confluence/placeholder/macro-headinga176.png?definition=e2NvZGU6dGl0bGU9ZGVmYXVsdF9zZXR0aW5ncy55bWx8bGFuZ3VhZ2U9YmFzaH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>parameters:
    acme_demo.default.foo_setting:
        foo: ~
        some: ~
        planets: [Earth]
        an_integer: 0
        enabled: false
        j_adore: les_sushis</pre></td></tr></table><p><span><span><br /></span></span></p><p><span><span>And then this semantic config:</span></span></p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash|title=ezpublish.yml or config.yml" style="background-image: url(../servlet/confluence/placeholder/macro-heading0b5a.png?definition=e2NvZGU6dGl0bGU9ZXpwdWJsaXNoLnltbCBvciBjb25maWcueW1sfGxhbmd1YWdlPWJhc2h9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>acme_demo:
    system:
        sa_group:
            foo_setting:
                foo: bar
                some: thing
                an_integer: 123

        # Assuming "sa1" is part of "sa_group"
        sa1:
            foo_setting:
                an_integer: 456
                enabled: true
                j_adore: le_saucisson</pre></td></tr></table><p><span><br /></span></p><p><span>What we want here, is that keys defined for </span><code>foo_setting</code><span> are merged between default/group/SiteAccess:</span></p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash|title=Expected result" style="background-image: url(../servlet/confluence/placeholder/macro-headinge413.png?definition=e2NvZGU6dGl0bGU9RXhwZWN0ZWQgcmVzdWx0fGxhbmd1YWdlPWJhc2h9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>parameters:
    acme_demo.sa1.foo_setting:
        foo: bar
        some: thing
        planets: [Earth]
        an_integer: 456
        enabled: true
        j_adore: le_saucisson</pre></td></tr></table><h4>Merge from <em>second level</em></h4><p>In the example above, entries were merged in respect to the scope order of precedence. However, if we define the <code>planets</code> key for<code>sa1</code>, it will completely override the default value since the merge process is done at only 1 level.</p><p>You can add another level by passing <code>ContextualizerInterface::MERGE_FROM_SECOND_LEVEL</code> as an option (3rd argument) to<code>$contextualizer-&gt;mapConfigArray()</code>.</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash|title=default_settings.yml" style="background-image: url(../servlet/confluence/placeholder/macro-headinga176.png?definition=e2NvZGU6dGl0bGU9ZGVmYXVsdF9zZXR0aW5ncy55bWx8bGFuZ3VhZ2U9YmFzaH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>parameters:
    acme_demo.default.foo_setting:
        foo: ~
        some: ~
        planets: [Earth]
        an_integer: 0
        enabled: false
        j_adore: [les_sushis]</pre></td></tr></table><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash|title=Semantic config (ezpublish.yml / config.yml)" style="background-image: url(../servlet/confluence/placeholder/macro-heading9832.png?definition=e2NvZGU6dGl0bGU9U2VtYW50aWMgY29uZmlnIChlenB1Ymxpc2gueW1sIC8gY29uZmlnLnltbCl8bGFuZ3VhZ2U9YmFzaH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>acme_demo:
    system:
        sa_group:
            foo_setting:
                foo: bar
                some: thing
                planets: [Mars, Venus]
                an_integer: 123

        # Assuming "sa1" is part of "sa_group"
        sa1:
            foo_setting:
                an_integer: 456
                enabled: true
                j_adore: [le_saucisson, la_truite_a_la_vapeur]</pre></td></tr></table><p>Result using <code>ContextualizerInterface::MERGE_FROM_SECOND_LEVEL</code> option:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=bash" style="background-image: url(../servlet/confluence/placeholder/macro-heading174f.png?definition=e2NvZGU6bGFuZ3VhZ2U9YmFzaH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>parameters:
    acme_demo.sa1.foo_setting:
        foo: bar
        some: thing
        planets: [Earth, Mars, Venus]
        an_integer: 456
        enabled: true
        j_adore: [les_suhis, le_saucisson, la_truite_a_la_vapeur]</pre></td></tr></table><table class="wysiwyg-macro" data-macro-name="info" style="background-image: url(../servlet/confluence/placeholder/macro-headingd35c.png?definition=e2luZm99&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>There is also another option, <code>ContextualizerInterface::UNIQUE</code>, to be used when you want to ensure your array setting has unique values. It will only work on normal arrays though, not hashes.</p></td></tr></table><h4>Limitations</h4><p>A few limitation exist with this scope hash merge:</p><ul class="task-list"><li>Semantic setting name and internal name will be the same (like <code>foo_setting</code> in the examples above).</li><li>Applicable to 1st level semantic parameter only (i.e. settings right under the SiteAccess name).</li><li>Merge is not recursive. Only 2nd level merge is possible by using <code>ContextualizerInterface::MERGE_FROM_SECOND_LEVEL</code> option.</li></ul><h2>Dedicated mapper object</h2><p><span>Instead of passing a callable to <code>$processor-&gt;mapConfig()</code>, an instance of <code>eZ\Bundle\EzPublishCoreBundle\DependencyInjection\Configuration\SiteAccessAware\ConfigurationMapperInterface</code> can be passed.</span></p><p><span>This can be useful if you have a lot of configuration to map and don't want to pollute your DIC extension class (better for maintenance).</span></p><h3>Merging hash values between scopes</h3><p><span><span>As specified above, </span><code>$contextualizer-&gt;mapConfigArray()</code><span> is not to be used within the </span><em>scope loop</em><span>, like for simple values. When using a closure/callable, you usually call it before or after </span><code>$processor-&gt;mapConfig()</code><span>. For mapper objects, a dedicated interface can be used: </span><code>HookableConfigurationMapperInterface</code><span>, which defines 2 methods: </span><code>preMap()</code><span> and </span><code>postMap()</code><span>.</span></span></p><p><span><br /></span></p><p> </p>
        <p>&nbsp;</p>
    </body>

<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=23528522 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 21 Oct 2014 10:09:29 GMT -->
</html>
