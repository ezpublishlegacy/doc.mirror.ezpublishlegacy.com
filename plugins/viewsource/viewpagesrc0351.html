                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    
<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=31429772 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 10:26:14 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
        <title>View Source</title>
        <link rel="canonical" href="../../pages/viewpage0351.html?pageId=31429772" />
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
</script>
<link type="text/css" rel="stylesheet" href="../../s/1b9968ac17721e3a6947d14e3a43c3f8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch9c16.css?build-number=5983" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f3685658010e413141854089096800b5/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/df762e50bc83a9608020a1ff1476cda6-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/5714bd5a5c86641cad10106916cda7c8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/6/_/styles/colors74cd.css?spaceKey=DEVELOPER" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/6/_/styles/custom74cd.css?spaceKey=DEVELOPER" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <div class="contentLayout2">
<div class="columnLayout two-right-sidebar" data-layout="two-right-sidebar">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p>As said in the introduction, the Type class of a Field Type must implement <code>eZ\Publish\SPI\FieldType\FieldType</code> (later referred to as &quot;Field Type interface&quot;).</p><p>All native Field Types also extend the <code>eZ\Publish\Core\FieldType\FieldType</code> abstract class that implements this interface and provides implementation facilities through a set of abstract methods of its own. In this case, Type classes implement a mix of methods from the Field Type interface and from the abstract Field Type.</p><p>Let’s go over those methods and their implementation.</p><h4>Identification method: <code>getFieldTypeIdentifier()</code></h4><p>It must return the string that uniquely identifies this Field Type (DataTypeString in legacy). We will use &quot;<code>eztweet</code>&quot;:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="9a36f1ac-081f-4bcc-b1b9-ebf9ce30db6f" data-macro-parameters="language=php|title=eZ/FieldType/Tweet/Type" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading797a.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPWVaL0ZpZWxkVHlwZS9Ud2VldC9UeXBlfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>public function getFieldTypeIdentifier()
{
   return 'eztweet';
}</pre></td></tr></table><h4>Value handling methods: <code>createValueFromInput()</code> and <code>checkValueStructure()</code></h4><p>Both methods are used by the abstract Field Type implementation of <code>acceptValue()</code>. This Field Type interface method checks and transforms various input values into the type's own Value class: <code>eZ\FieldType\Tweet\Value</code>. This method must:</p><ul><li>either return the Value object it was able to create out of the input value,</li><li>or return this value untouched. The API will detect this and inform that the input value was not accepted.</li></ul><p>The only acceptable value for our type is the URL of a tweet (we could of course imagine more possibilities). This should do:</p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="5ebb9125-32cb-428e-84a3-b6d5e73ccd22" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>protected function createValueFromInput( $inputValue )
{
   if ( is_string( $inputValue ) )
   {
       $inputValue = new Value( array( 'url' => $inputValue ) );
   }
 
   return $inputValue;
}
</pre></td></tr></table><p><br /> Use this method to provide convenient ways to set an attribute’s value using the API. This can be anything from primitives to complex business objects.</p><p>Next, we will implement <code>
    checkValueStructure()</code>. It is called by the abstract Field Type to ensure that the Value fed to the Type is acceptable. In our case, we want to be sure that <code>Tweet</code> <code>
    \Value::$url</code> is a string:</p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="2017f4f2-5013-4b2c-a0e2-4be8a222d060" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>protected function checkValueStructure( BaseValue $value )
{
   if ( !is_string( $value->url ) )
   {
       throw new eZ\Publish\Core\Base\Exceptions\InvalidArgumentType(
           '$value->url',
           'string',
           $value->url
       );
   }
}
</pre></td></tr></table><p>Yes, we execute the same check as in <code>createValueFromInput()</code>. But both methods aren't responsible for the same thing. The first will, <em>if given something else than a Value of its type</em>, try to convert it to one. <code>checkValueStructure()</code> will always be used, even if the Field Type is directly fed a <code>Value</code> object, and not a string.</p><h4>Value initialization: <code>getEmptyValue()</code></h4><p>This method provides what is considered as an empty value of this type, depending on our business requirements. No extra initialization is required in our case.</p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="e86cc118-b608-4d9d-8594-17edc89f6840" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>public function getEmptyValue()
{
   return new Value;
}</pre></td></tr></table><p>If you run the unit tests at this point, you should get about five failures, all of them on the <code>fromHash()</code> or <code>
    toHash()</code> methods.</p><h4>Validation methods: <code>validateValidatorConfiguration()</code> and <code>validate()</code></h4><p>The Type class is also responsible for validating input data (to a <code>Field</code>), as well as configuration input data (to a <code>FieldDefinition</code>). In this tutorial, we will run two validation operations on input data:</p><ul><li><p>validate submitted urls, ensuring they actually reference a twitter status;</p></li><li><p>limit input to a known list of authors, as an optional validation step.</p></li></ul><p><code>
    validateValidatorConfiguration()</code> will be called when an instance of the Field Type is added to a Content Type, to ensure that the validator configuration is valid. For a TextLine (length validation), it means checking that both min length and max length are positive integers, and that min is lower than max.</p><p>When an instance of the type is added to a Content Type, <code>validateValidatorConfiguration()</code> receives the configuration for the validators used by the Type as an array. It must return an array of error messages if errors are found in the configuration, and an empty array if no errors were found.</p><p>For TextLine, the provided array looks like this:</p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="11e14603-180f-45dd-91f3-caa9b7effd32" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>array(
   'StringLengthValidator' => array(
       'minStringLength' => 0,
       'maxStringLength' => 100
   )
);
</pre></td></tr></table><p>The structure of this array is totally free, and up to each type implementation. We will in this tutorial mimic what is done in native Field Types:</p><p>Each level one key is the name of a validator, as acknowledged by the Type. That key contains a set of parameter name / parameter value rows. We must check that:</p><ul><li><p>all the validators in this array are known to the type</p></li><li><p>arguments for those validators are valid and have sane values</p></li></ul><p>We do not need to include mandatory validators if they don’t have options. Here is an example of what our Type expects as validation configuration:</p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="1648a005-d849-47e3-96b0-5fded327640a" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>array(
   ‘TweetAuthorValidator’ => array(
       ‘AuthorList’ => array( ‘johndoe’, ‘janedoe’ )
   )
);
</pre></td></tr></table><p><br /> The configuration says that tweets must be either by johndoe or by janedoe. If we had not provided TweetAuthorValidator at all, it would have been ignored.</p><p>We will iterate over the items in <code>$validatorConfiguration</code> and:</p><ul><li><p>add errors for those we don’t know about;</p></li><li><p>check that provided arguments are known and valid:</p></li><ul><li><p>TweetAuthorValidator accepts a non-empty array of valid Twitter usernames</p></li></ul></ul><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="d59351b9-d700-493a-b56f-f1feb1e2b758" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>public function validateValidatorConfiguration( $validatorConfiguration )
{
   $validationErrors = array();

   foreach ( $validatorConfiguration as $validatorIdentifier => $constraints )
   {
       // Report unknown validators
       if ( !$validatorIdentifier != 'TweetAuthorValidator' )
       {
           $validationErrors[] = new ValidationError( "Validator '$validatorIdentifier' is unknown" );
           continue;
       }
 
       // Validate arguments from TweetAuthorValidator
       if ( !isset( $constraints['AuthorList'] ) || !is_array( $constraints['AuthorList'] ) )
       {
           $validationErrors[] = new ValidationError( "Missing or invalid AuthorList argument" );
           continue;
       }
 
       foreach ( $constraints['AuthorList'] as $authorName )
       {
           if ( !preg_match( '/^[a-z0-9_]{1,15}$/i', $authorName ) )
           {
               $validationErrors[] = new ValidationError( "Invalid twitter username" );
           }
       }
   }

 
   return $validationErrors;
}</pre></td></tr></table><p><code>
    validate()</code> is the method that runs the actual validation on data, when a content item is created with a Field of this type:</p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="9f1c9754-c63b-4ae1-9852-dde46039c3b2" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>   public function validate( FieldDefinition $fieldDefinition, SPIValue $fieldValue )
   {
       $errors = array();

       if ( $this->isEmptyValue( $fieldValue ) )
       {
           return $errors;
       }
 
       // Tweet Url validation
       if ( !preg_match( '#^https?://twitter.com/([^/]+)/status/[0-9]+$#', $fieldValue->url, $m ) )
           $errors[] = new ValidationError( "Invalid twitter status url %url%", null, array( $fieldValue->url ) );

       $validatorConfiguration = $fieldDefinition->getValidatorConfiguration();
       if ( isset( $validatorConfiguration['TweetAuthorValidator'] ) )
       {
           if ( !in_array( $m[1], $validatorConfiguration['TweetAuthorValidator']['AuthorList'] ) )
           {
               $errors[] = new ValidationError(
                   "Twitter user %user% is not in the approved author list",
                   null,
                   array( $m[1] )
               );
           }
       }
 
       return $errors;
   }
</pre></td></tr></table><p>First, we validate the url with a regular expression. If it doesn’t match, we add an instance of <code>
    ValidationError
  </code> to the return array. Note that the tested value isn’t directly embedded in the message but passed as an argument. This ensures that the variable is properly encoded in order to prevent attacks, and allows for singular/plural phrases using the second parameter.</p><p>Then, if our Field Type instance’s configuration contains a <code>
    TweetAuthorValidator
  </code> key, we check that the username in the status url matches one of the valid authors.</p><h4>Metadata handling methods: <code>getName()</code> and <code>getSortInfo()</code>.</h4><p>Field Types require two methods related to Field metadata:</p><ul><li><p><code>
getName()
      </code> is used to generate a name out of a Field value, either to name a Content item (naming pattern in legacy) or to generate a part for an URL Alias.</p></li><li><p><code>
getSortInfo()
      </code> is used by the persistence layer to obtain the value it can use to sort &amp; filter on a Field of this type</p></li></ul><p>Obviously, a tweet’s full URL isn’t really suitable as a name. Let’s use a subset of it: <code>
    &lt;username&gt;-&lt;tweetId&gt;
  </code> should be reasonable enough, and suitable for both sorting and naming.</p><p> </p><p>We can assume that this method will not be called if the Field is empty, and will assume that the URL is a valid twitter URL:</p><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="287ccc70-6bb4-406a-850d-9cea057e53ad" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>public function getName( SPIValue $value )
{
   return preg_replace(
       '#^https?://twitter\.com/([^/]+)/status/([0-9]+)$#',
       '$1-$2',
       (string)$value->url );
}

 
protected function getSortInfo( CoreValue $value )
{
   return $this->getName( $value );
}</pre></td></tr></table><p>In <code>
    getName()</code> we run a regular expression replace on the URL to extract the part we’re interested in.</p><p>This name is a perfect match for <code>
    getSortInfo()</code> as it allows us to sort on the tweet’s author and on the tweet’s ID.</p><h4>Field Type serialization methods: <code>fromHash()</code> and <code>toHash()</code></h4><p>Both methods defined in the Field Type interface, are core to the REST API. They are used to export values to serializable hashes.</p><p>In our case, it is quite easy:</p><ul><li><p><code>
toHash()
      </code> will build a hash with every property from <code>Tweet\Value</code>;</p></li><li><p><code>
fromHash()
      </code> will instantiate a <code>Tweet\Value</code> with the hash it receives.  </p></li></ul><p> </p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="1ed89bef-cf05-4596-bb03-2716919c70f1" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>public function fromHash( $hash )
{
   if ( $hash === null )
   {
       return $this->getEmptyValue();
   }
   return new Value( $hash );
}
 
public function toHash( SPIValue $value )
{
   if ( $this->isEmptyValue( $value ) )
   {
       return null;
   }
   return array(
       'url' => $value->url
   );
}
</pre></td></tr></table><h4>Persistence methods: <code>fromPersistenceValue</code> and <code>toPersistenceValue</code></h4><p>Storage of Field Type data is done through the persistence layer (SPI).</p><p>Field Types use their own Value objects to expose their contents using their own domain language. However, to store those objects, the Type needs to map this custom object to a structure understood by the persistence layer: <code>PersistenceValue</code>. This simple value object has three properties:</p><ul style="list-style-type: square;"><li><code>data</code> – standard data, stored using the storage engine's native features</li><li><code>externalData</code> – external data, stored using a custom storage handler</li><li><code>sortKey</code> – sort value used for sorting</li></ul><p>The role of those mapping methods is to convert a <code>Value</code> of the Field Type into a <code>PersistenceValue</code> and the other way around.</p><table class="wysiwyg-macro" data-macro-name="info" data-macro-id="7803d56f-c89a-40e0-9cbb-fe225639195c" data-macro-parameters="title=About external storage" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading6fe4.png?definition=e2luZm86dGl0bGU9QWJvdXQgZXh0ZXJuYWwgc3RvcmFnZX0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>Whatever is stored in {{externalData}} requires an external storage handler to be written. Read more about external storage on <a class="confluence-link" href="../../display/DEVELOPER/Field%2bType%2bAPI%2band%2bbest%2bpractices.html" data-linked-resource-id="31430767" data-linked-resource-version="5" data-linked-resource-type="page" data-linked-resource-default-alias="Field Type API and best practices" data-base-url="../../index.html">Field Type API and best practices</a>.</p><p>External storage is beyond the scope of this tutorial, but many examples can be found in existing Field Types.</p></td></tr></table><p>We will follow a simple implementation here: the <code>Tweet\Value</code> object will be serialized as an array to the <code>code</code> property using <code>fromHash()</code> and <code>toHash()</code>:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="d1faa226-4fc5-4961-bf35-192a6c861710" data-macro-parameters="language=php|title=Tweet\\Type" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading781e.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPVR3ZWV0XFR5cGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>/**
 * @param \EzSystems\TweetFieldTypeBundle\eZ\Publish\FieldType\Tweet\Value $value
 * @return \eZ\Publish\SPI\Persistence\Content\FieldValue
 */
public function toPersistenceValue( SPIValue $value )
{
    if ( $value === null )
    {
        return new PersistenceValue(
            array(
                "data" => null,
                "externalData" => null,
                "sortKey" => null,
            )
        );
    }
    return new PersistenceValue(
        array(
            "data" => $this->toHash( $value ),
            "sortKey" => $this->getSortInfo( $value ),
        )
    );
}
/**
 * @param \eZ\Publish\SPI\Persistence\Content\FieldValue $fieldValue
 * @return \EzSystems\TweetFieldTypeBundle\eZ\Publish\FieldType\Tweet\Value
 */
public function fromPersistenceValue( PersistenceValue $fieldValue )
{
    if ( $fieldValue->data === null )
    {
        return $this->getEmptyValue();
    }
    return new Value( $fieldValue->data );
}</pre></td></tr></table><p> </p><h5>Fetching data from the Twitter API</h5><p>As explained in the tutorial's introduction, we will enrich our tweet's URL with the embed version, fetched using the Twitter API. To do so, we will, when <code>toPersistenceValue()</code> is called, fill in the value's contents property from this method, before creating the <code>PersistenceValue</code> object.</p><p>First, we need a twitter client in <code>Tweet\Type</code>. For convenience, we provide one in this tutorial's bundle:</p><div><ul style="list-style-type: square;"><li>The <code>Twitter\TwitterClient</code> class:</li><li>The <code>Twitter\TwitterClientInterface</code> interface</li><li>An <code>ezsystems.tweetbundle.twitter.client</code> service that uses the class above.</li></ul><p>The interface has one method: <code>getEmbed( $statusUrl )</code> that, given a tweet's URL, returns the embed code as a string. The implementation is very simple, for the sake of simplicity, but gets the job done. Ideally, it should at the very least handle errors, but it is not necessary here.</p><h6>Injecting the Twitter client into <code>Tweet\Type</code></h6><p>Our Field Type doesn't have a constructor yet. We will create one, with an instance of <code>Twitter\TwitterClientInterface</code> as the argument, and store it in a new protected property:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="c7f29799-a43b-4460-80f6-b1821f46bdad" data-macro-parameters="language=php|title=eZ/Publish/FieldType/Tweet/Type.php:" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading2487.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPWVaL1B1Ymxpc2gvRmllbGRUeXBlL1R3ZWV0L1R5cGUucGhwOn0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>use EzSystems\TweetFieldTypeBundle\Twitter\TwitterClientInterface;
 
class Type extends FieldType
{
    /** @var TwitterClientInterface */
    protected $twitterClient;

    public function __construct( TwitterClientInterface $twitterClient )
    {
        $this->twitterClient = $twitterClient;
    }
}</pre></td></tr></table><h6>Completing the value using the twitter client</h6><p>As described above, before creating the <code>PersistenceValue</code> object in <code>toPersistenceValue</code>, we will fetch the tweet's embed contents using the client, and assign it to <code>Tweet\Value::$data</code>:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="7840402c-d275-4456-bad3-2e6b05c26d5a" data-macro-parameters="language=php|title=eZ/Publish/FieldType/Tweet/Type.php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingdf05.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPWVaL1B1Ymxpc2gvRmllbGRUeXBlL1R3ZWV0L1R5cGUucGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre> public function toPersistenceValue( SPIValue $value )
{
    // if ( $value === null )
    // {...}


    if ( $value->contents === null )
    {
        $value->contents = $this->twitterClient->getEmbed( $value->url );
    }
    return new PersistenceValue(
    // array(...)
}

</pre></td></tr></table><p>And that's it! When the persistence layer stores content from our type, the value will be completed with what the twitter API returns.</p><p> </p></div></div>
</div>
<div class="cell aside" data-type="aside">
<div class="innerCell">
<table class="wysiwyg-macro" data-macro-name="panel" data-macro-id="e5d4c3f2-1aae-44b2-88ab-6039da6cff42" data-macro-parameters="title=Tutorial path" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headinga671.png?definition=e3BhbmVsOnRpdGxlPVR1dG9yaWFsIHBhdGh9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p><img class="editor-inline-macro" src="../servlet/confluence/placeholder/macrof992.png?definition=e3BhZ2V0cmVlOnJvb3Q9Q3JlYXRpbmcgYSBUd2VldCBGaWVsZCBUeXBlfQ&amp;locale=en_GB&amp;version=2" data-macro-name="pagetree" data-macro-id="86f4b2ed-867a-4e9c-901b-a78a32196334" data-macro-parameters="root=Creating a Tweet Field Type" data-macro-schema-version="1"></p></td></tr></table></div>
</div>
</div>
</div>
        <p>&nbsp;</p>
    </body>

<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=31429772 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 10:26:14 GMT -->
</html>
