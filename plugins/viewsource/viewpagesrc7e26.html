                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    
<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=13468101 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 13:27:51 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
        <title>View Source</title>
        <link rel="canonical" href="../../pages/viewpage7e26.html?pageId=13468101" />
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
</script>
<link type="text/css" rel="stylesheet" href="../../s/1b9968ac17721e3a6947d14e3a43c3f8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch9c16.css?build-number=5983" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f3685658010e413141854089096800b5/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/df762e50bc83a9608020a1ff1476cda6-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/5714bd5a5c86641cad10106916cda7c8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/16/_/styles/colors556c.css?spaceKey=EZP51" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/16/_/styles/custom556c.css?spaceKey=EZP51" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <p> </p><p> </p><p>The ContentService implemented in eZ Publish 5.1 has no knowledge of the Legacy workflow engine. This means that all features in the 4.x series that used workflows need a workaround. One of the most common use-cases is pre-publishing approval, for instance of user generated content.</p><h2>Legacy kernel callbacks</h2><p>Fortunately, there is a quite simple way to trigger workflows from eZ Publish 5 code: by using a Legacy Kernel Callback. The overall process is described in the <a class="confluence-link" href="../../display/EZP51/Legacy%2bcode%2band%2bfeatures.html" data-linked-resource-id="12125325" data-linked-resource-version="12" data-linked-resource-type="page" data-linked-resource-default-alias="Legacy code and features" data-base-url="https://doc.ez.no">Legacy code and features</a> documentation chapter.</p><h1>Create with the Public API, publish with the Legacy Kernel</h1><p>Thanks to this, it is possible to create a draft using native eZ Publish 5 code, and get this draft pre-approved using the legacy workflow &amp; collaboration systems, including email notifications.</p><h3>Legacy workflow configuration</h3><p>Let's take an approval workflow as an example. It needs to be configured the old way, using the backoffice. Create a workflow, add an <a href="../../eZ-Publish/Technical-manual/4.x/Reference/Workflow-events/Approve.html">Approve event</a> to it, and connect it to the content/publish/before trigger.</p><h3>Create a draft using the public API</h3><p>This is done the usual way, as extensively covered in the <a class="confluence-link" href="../../display/EZP51/3.html" data-linked-resource-id="12125358" data-linked-resource-version="4" data-linked-resource-type="page" data-linked-resource-default-alias="3. Managing Content" data-base-url="https://doc.ez.no">Public API Cookbook</a>. The main different is that we will NOT call <code>ContentService::publishVersion()</code>.</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=Create content using the Public API" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1c30.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPUNyZWF0ZSBjb250ZW50IHVzaW5nIHRoZSBQdWJsaWMgQVBJfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>$contentType = $contentTypeService->loadContentTypeByIdentifier( $contentTypeIdentifier );

$contentCreateStruct = $contentService->newContentCreateStruct( $contentType, 'eng-GB' );
$contentCreateStruct->setField( 'title', $title );
$contentCreateStruct->setField( 'intro', $intro );
$contentCreateStruct->setField( 'body', $body );

$locationCreateStruct = $locationService->newLocationCreateStruct( $parentLocationId );


// create a draft using the content and location create struct and publish it
$draft = $contentService->createContent( $contentCreateStruct, array( $locationCreateStruct ) );

</pre></td></tr></table><h2>Publish a Public API draft using the Legacy Kernel</h2><p> </p><p>You need to use the object to run a Legacy Kernel Callback (e.g. code fragment). This legacy code will execute the publish operation with the given content id and version number. It will then check the operation result, and return true or false, depending if the operation went all the way through, or if it was interrupted (approval workflow event, for instance). This handling could and should <em>of course</em> be enhanced, with error handling to begin with, but it doesn't change the core principle.</p><p>This example will work in any controller that extends <code>eZ\Publish\EzPublishCoreBundle\Controller</code>:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>/**
 * @param $contentId
 * @param $versionId
 * @return bool true if the operation was completed, false if it was interrupted
 */
protected function runLegacyPublish( $contentId, $versionId, $runAsUserId = null )
{
    $legacyKernel = $this->getLegacyKernel();
    return $legacyKernel->runCallback(
        function () use ( $contentId, $versionId, $runAsUserId )
        {

            $db = \eZDB::instance();
            $transactionCounter = $db->transactionCounter();
            if ( $runAsUserId )
            {
                \eZUser::setCurrentlyLoggedInUser( \eZUser::fetch( $runAsUserId ), $runAsUserId );
            }
            $operationResult = \eZOperationHandler::execute(
                'content', 'publish', array( 'object_id' => $contentId, 'version' => $versionId )
            );
            if ( ( array_key_exists( 'status', $operationResult ) &amp;&amp; $operationResult['status'] != \eZModuleOperationInfo::STATUS_CONTINUE ) )
            {
                // Required by https://jira.ez.no/browse/EZP-20558
                for ( $i = 0, $counter = ( $db->transactionCounter() - $transactionCounter ); $i &lt; $counter; ++$i )
                {
                    $db->commit();
                }
                return false;
            }
            return true;
        }
    );
}</pre></td></tr></table><table class="wysiwyg-macro" data-macro-name="info" data-macro-parameters="title=eZ Script context" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading3a8c.png?definition=e2luZm86dGl0bGU9ZVogU2NyaXB0IGNvbnRleHR9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>If you are running the callback in a command line script, you need to add these calls before executing any legacy code:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1802.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>$script = \eZScript::instance( array( 'use-modules' => true ) );
$script->initialize();</pre></td></tr></table></td></tr></table><p> </p><p>Any Legacy code can be executed this way. While it is a <em>backward compatibility</em> feature, it is considered good practice to work around missing features. It is however not recommended to rely heavily on Legacy features for performances reasons.</p><table class="wysiwyg-macro" data-macro-name="note" data-macro-parameters="title=Pay attention to the user" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingd8b2.png?definition=e25vdGU6dGl0bGU9UGF5IGF0dGVudGlvbiB0byB0aGUgdXNlcn0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>Public API code is always executed as a user, by default anonymous. Since workflows are often user dependent (Approval is), it is important that this code is executed as an editor, or as a user who will trigger the workflow.</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=Logging in a user on the Public API repository" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading481d.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPUxvZ2dpbmcgaW4gYSB1c2VyIG9uIHRoZSBQdWJsaWMgQVBJIHJlcG9zaXRvcnl9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>$repository->setCurrentUser( $repository->getUserService()->loadUser( $userId ) );</pre></td></tr></table><p>Of course, this isn't required when using Public API code in controllers, since those will use the currently-logged in user.</p><p><strong>Legacy code</strong><strong> also requires a user</strong></p><p>By default, code in <code>LegacyKernel::runCallback()</code> calls is executed as anonymous. You'll have to log the executing user manually <em>on legacy as well</em>.</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=Logging in a user with the Legacy Kernel" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading3675.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPUxvZ2dpbmcgaW4gYSB1c2VyIHdpdGggdGhlIExlZ2FjeSBLZXJuZWx9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>\eZUser::setCurrentlyLoggedInUser( \eZUser::fetch( $runAsUserId ), $runAsUserId );</pre></td></tr></table></td></tr></table><p> </p><h1>Data compatibility and workflow collaboration</h1><p>Content created using the Public API does appear as expected in the dashboard, and the draft can be checked from here. Collaboration options from the backoffice are available, and the object's lifecycle can be managed the way it used to with eZ Publish 4.x.</p><h1>Test script</h1><p>The code below is a working Command script example that demonstrates the workaround. Just drop it in a bundle and update the namespace: <a href="https://gist.github.com/bdunogier/e05ed564770fa6a51e51">https://gist.github.com/bdunogier/e05ed564770fa6a51e51</a></p><p> </p>
        <p>&nbsp;</p>
    </body>

<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=13468101 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 13:27:51 GMT -->
</html>
