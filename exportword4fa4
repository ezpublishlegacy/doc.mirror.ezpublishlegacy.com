Message-ID: <1526046296.760.1413881533731.JavaMail.confluence@ip-10-127-227-192>
Subject: Exported From Confluence
MIME-Version: 1.0
Content-Type: multipart/related; 
	boundary="----=_Part_759_446658023.1413881533730"

------=_Part_759_446658023.1413881533730
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
Content-Location: file:///C:/exported.html

<html xmlns:o=3D'urn:schemas-microsoft-com:office:office'
      xmlns:w=3D'urn:schemas-microsoft-com:office:word'
      xmlns:v=3D'urn:schemas-microsoft-com:vml'
      xmlns=3D'urn:w3-org-ns:HTML'>
<head>
    <meta http-equiv=3D"Content-Type" content=3D"text/html; charset=3Dutf-8=
">
    <title>Upgrading from 5.1 to 5.3</title>
    <!--[if gte mso 9]>
    <xml>
        <o:OfficeDocumentSettings>
            <o:TargetScreenSize>1024x640</o:TargetScreenSize>
            <o:PixelsPerInch>72</o:PixelsPerInch>
            <o:AllowPNG/>
        </o:OfficeDocumentSettings>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>90</w:Zoom>
            <w:DoNotOptimizeForBrowser/>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
                <!--
        @page Section1 {
            size: 8.5in 11.0in;
            margin: 1.0in;
            mso-header-margin: .5in;
            mso-footer-margin: .5in;
            mso-paper-source: 0;
        }

        td {
            page-break-inside: avoid;
        }

        tr {
            page-break-after: avoid;
        }

        div.Section1 {
            page: Section1;
        }

        /* Confluence print stylesheet. Common to all themes for print medi=
a */
/* Full of !important until we improve batching for print CSS */

#main {
    padding-bottom: 1em !important; /* The default padding of 6em is too mu=
ch for printouts */
}

body {
    font-family: Arial, Helvetica, FreeSans, sans-serif;
    font-size: 10pt;
    line-height: 1.2;
}

body, #full-height-container, #main, #page, #content, .has-personal-sidebar=
 #content {
    background: #fff    !important;
    color: #000         !important;
    border: 0           !important;
    width: 100%         !important;
    height: auto        !important;
    min-height: auto    !important;
    margin: 0           !important;
    padding: 0          !important;
    display: block      !important;
}

a, a:link, a:visited, a:focus, a:hover, a:active {
    color: #000;
}
#content h1,
#content h2,
#content h3,
#content h4,
#content h5,
#content h6 {
    font-family: Arial, Helvetica, FreeSans, sans-serif;
    page-break-after: avoid;
}
pre {
    font-family: Monaco, "Courier New", monospace;
}

#header,
.aui-header-inner,
#navigation,
#sidebar,
.sidebar,
#personal-info-sidebar,
.ia-fixed-sidebar,
.page-actions,
.navmenu,
.ajs-menu-bar,
.noprint,
.inline-control-link,
.inline-control-link a,
a.show-labels-editor,
.global-comment-actions,
.comment-actions,
.quick-comment-container,
#addcomment {
    display: none !important;
}

.comment .date::before {
    content: none !important; /* remove middot for print view */
}

h1.pagetitle img {
    height: auto;
    width: auto;
}

.print-only {
    display: block;
}
#footer {
    position: relative !important; /* CONF-17506 Place the footer at end of=
 the content */
    margin: 0;
    padding: 0;
    background: none;
    clear: both;
}

#poweredby {
    border-top: none;
    background: none;
}

#poweredby li.print-only {
    display: list-item;
    font-style: italic;
}

#poweredby li.noprint {
    display:none;
}


/* no width controls in print */
.wiki-content .table-wrap,
.wiki-content p,
.panel .codeContent,
.panel .codeContent pre,
.image-wrap {
    overflow: visible !important;
}

/* TODO - should this work? */
#children-section,
#comments-section .comment,
#comments-section .comment .comment-body,
#comments-section .comment .comment-content,
#comments-section .comment p {
    page-break-inside: avoid;
}

#page-children a {
    text-decoration: none;
}

/**
 hide twixies

 the specificity here is a hack because print styles
 are getting loaded before the base styles. */
#comments-section.pageSection .section-header,
#comments-section.pageSection .section-title,
#children-section.pageSection .section-header,
#children-section.pageSection .section-title,
.children-show-hide {
    padding-left: 0;
    margin-left: 0;
}

.children-show-hide.icon {
    display: none;
}

/* personal sidebar */
.has-personal-sidebar #content {
    margin-right: 0px;
}

.has-personal-sidebar #content .pageSection {
    margin-right: 0px;
}
-->
    </style>
</head>
<body>
    <h1>Upgrading from 5.1 to 5.3</h1>
    <div class=3D"Section1">
        <div class=3D"attribute-heading">
<p><span style=3D"color: rgb(51,51,51);font-size: 14.0px;line-height: 1.428=
5715;"><style type=3D"text/css">/*<![CDATA[*/
div.rbtoc1413881533630 {padding: 0px;}
div.rbtoc1413881533630 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1413881533630 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style></span></p>
<div class=3D"toc-macro rbtoc1413881533630">=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Upgradingfrom5.1to5.3-NoteonPaths">Note on Paths</a></li>=
=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Checkforrequirements">Check for requi=
rements</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Upgradesteps">Upgrade steps</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step1:Upgradethedistributionfiles">St=
ep 1: Upgrade the distribution files</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step2:upgradecustomextensions">Step 2=
: upgrade custom extensions</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step3:upgradethedatabase">Step 3: upg=
rade the database</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Upgradingfrom5.1to5.3-DefineaDoctrineconnection">Define a D=
octrine connection</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Defineoneorseveralrepositories">Defin=
e one or several repositories</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-(Optional)MakeyourSiteAccessconfigpoi=
nttotherightrepository">(Optional) Make your SiteAccess config point to the=
 right repository</a></li>=20
</ul> </li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step4:Apply5.2&amp;5.3configurationch=
anges">Step 4: Apply 5.2 &amp; 5.3 configuration changes</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Upgradingfrom5.1to5.3-YAMLfiles">YAML files</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Sessionname">Session name</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Routing">Routing</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-SecurityInezpublish/config/security.y=
ml,addthefollowing:">&nbsp;Security In&nbsp;ezpublish/config/security.yml, =
add the following:</a></li>=20
</ul> </li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Templates">Templates</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Upgradingfrom5.1to5.3-ezpublish/EzPublishKernel.php">ezpubl=
ish/EzPublishKernel.php</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-composer.json">composer.json</a></li>=
=20
</ul> </li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Varnish(ifapplicable)">Varnish (if ap=
plicable)</a></li>=20
</ul> </li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step5:Updateclusterdata(ifapplicable)=
">Step 5: Update cluster data (if applicable)</a>=20
<ul class=3D"toc-indentation">=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Option1:unclusterize,cleardata,andrec=
lusterize">Option 1: unclusterize, clear data, and reclusterize</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Option2:performabackgroundcleanupofth=
estoragetable">Option 2: perform a background cleanup of the storage table<=
/a></li>=20
</ul> </li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step6:Regeneratetheautoloadarrayforex=
tensions">Step 6: Regenerate the autoload array for extensions</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step7:Linkassets">Step 7: Link assets=
</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step8:Updaterewriterules">Step 8: Upd=
ate rewrite rules</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step9:Clearthecaches">Step 9: Clear t=
he caches</a></li>=20
<li><a href=3D"#Upgradingfrom5.1to5.3-Step10:UpgradeExtensions(sitepackage)=
">Step 10: Upgrade Extensions (site package)</a></li>=20
</ul> </li>=20
</ul>=20
</div>
<br />
<p></p>
<p><span style=3D"color: rgb(51,51,51);font-size: 14.0px;line-height: 1.428=
5715;">This section describes how to upgrade your existing eZ Publish 5.1 i=
nstallation to version 5.3. Make sure that you have a working backup of the=
 site before you do the actual upgrade, and make sure that the installation=
 you are performing the upgrade on is offline.</span></p>
</div>
<h2 id=3D"Upgradingfrom5.1to5.3-NoteonPaths">Note on Paths</h2>
<ul>
<li><em>/&lt;ezp5-root&gt;/</em>: The root directory where eZ Publish 5 is =
installed in, examples: &quot;<em>/home/myuser/www</em>/&quot; or &quot;<em=
>/var/sites/ezpublish/</em>&quot;</li>
<li><em>/&lt;ezp5-root&gt;/ezpublish_legacy</em>: &nbsp;Root&nbsp;directory=
&nbsp;of&nbsp;&quot;Legacy&quot; (aka &quot;Legacy Stack&quot;, refers to t=
he eZ Publish 4.x&nbsp;installation&nbsp;which is bundled with eZ Publish 5=
) normally inside &quot;<em>ezpublish_legacy</em>/&quot;, example: &quot;<e=
m>/home/myuser/www/ezpublish_legacy/</em>&quot;</li>
</ul>
<h2 id=3D"Upgradingfrom5.1to5.3-Checkforrequirements">Check for requirement=
s</h2>
<p>PHP 5.3.3 and higher is needed. Further information regarding System Req=
uirements can be found on&nbsp;<a href=3D"https://confluence.ez.no/display/=
EZP/Requirements" class=3D"external-link" rel=3D"nofollow">Requirements Doc=
umentation Page</a>.<a name=3D"eztoc126882_2" rel=3D"nofollow"></a></p>
<h2 id=3D"Upgradingfrom5.1to5.3-Upgradesteps">Upgrade steps<a name=3D"eztoc=
126882_1" rel=3D"nofollow"></a></h2>
<h3 id=3D"Upgradingfrom5.1to5.3-Step1:Upgradethedistributionfiles">Step 1: =
Upgrade the distribution files</h3>
<p>The easiest way to upgrade the distribution files is to unpack eZ Publis=
h 5.3 to a separate directory and then copy the directories that contain si=
te-specific files from the existing 5.1 installation into &quot;<em>/&lt;ez=
p5-root&gt;/</em>&quot;. Make sure you copy the following directories:</p>
<ul>
<li><code>ezpublish_legacy/design/&lt;your designs&gt;</code> (do NOT inclu=
de built-in designs: admin, base, standard or admin2)</li>
<li><code>ezpublish_legacy/var/&lt;your_var_dir&gt;/storage</code></li>
<li><code>ezpublish_legacy/var/storage/packages</code></li>
<li><code>ezpublish_legacy/settings/siteaccess/&lt;your_siteaccesses&gt;</c=
ode></li>
<li><code>ezpublish_legacy/settings/override/*</code></li>
<li><code>ezpublish_legacy/extension/*</code> (not including the built-in /=
 standalone ones: ezflow, ezjscore, ezoe, ezodf, ezie, ezmultiupload, ezmbp=
aex, ez_network, ezprestapiprovider, ezscriptmonitor, ezsi, ezfind)</li>
<li>src/</li>
<li><code>config.php</code> &amp; <code>config.cluster.php</code>, if appli=
cable</li>
<li><code>ezpublish/config/*</code></li>
</ul>
<p><em><strong>NB:</strong>&nbsp;Since writable directories and files have =
been replaced / copied, their permissions might have changed. You may have =
to reconfigure webserver user permissions on specific folders as explained =
in the file&nbsp;<a href=3D"https://confluence.ez.no/pages/viewpage.action?=
pageId=3D7438581#InstallingeZPublishonaLinux%2FUNIXbasedsystem-Settingupfol=
derpermission" class=3D"external-link" rel=3D"nofollow">permissions chapter=
 of the installation process</a>.</em></p>=20
<div class=3D"aui-message hint shadowed information-macro">=20
<p class=3D"title">opcode cache</p>=20
<span class=3D"aui-icon icon-hint">Icon</span>=20
<div class=3D"message-content">=20
<p>If you use APC, or an op-code cache solution, make sure to clear the cac=
he. The easiest way is to restart your web server.</p>=20
</div>=20
</div>=20
<h3 id=3D"Upgradingfrom5.1to5.3-Step2:upgradecustomextensions">Step 2: upgr=
ade custom extensions</h3>
<p>If you are using custom extensions, the sub-directories inside the &quot=
;extension&quot; directory will also have to be copied from the existing 5.=
1 installation into &quot;<em>/&lt;ezp5-root&gt;/ezpublish_legacy/extension=
/</em>&quot;. However, make sure that you do not overwrite any extensions t=
hat are included in eZ Publish&nbsp;distribution, which currently are (<em>=
<strong>Note:</strong>&nbsp;As of eZ Publish 5.2, these extensions have the=
 same version number as eZ Publish</em>):</p>
<p>Note that upgrading the distribution files will overwrite the autoload a=
rrays for extensions. You will need to re-generate the autoload arrays for =
active extensions later.</p>
<p><em><strong>Important:&nbsp;</strong>If you plan to upgrade your eZ Webs=
ite Interface, eZ Flow or eZ Demo site package as well, then&nbsp;additiona=
l&nbsp;extensions will be updated and the step for&nbsp;re-generate the aut=
oload arrays can be skipped until that is done (links to documentation for =
upgrading these site packages can be found in the last step of this page).<=
/em><a name=3D"eztoc126882_4" rel=3D"nofollow"></a></p>
<h3 id=3D"Upgradingfrom5.1to5.3-Step3:upgradethedatabase">Step 3: upgrade t=
he database</h3>
<p>For upgrading the database, you have to jump from 5.1 to 5.2 and then fr=
om 5.2 to 5.3.</p>
<p>Import to your database the changes provided in :</p>
<pre class=3D"wordwrap"><span class=3D"line">/&lt;ezp5-root&gt;/ezpublish_l=
egacy/update/database/&lt;mysql|postgresql&gt;/5.2/dbupdate-5.1.0-to-5.2.0.=
sql</span></pre>
<pre class=3D"wordwrap"><span class=3D"line">/&lt;ezp5-root&gt;/ezpublish_l=
egacy/update/database/&lt;mysql|postgresql&gt;/5.3/dbupdate-5.2.0-to-5.3.0.=
sql</span></pre>
<ul>
<li><h4 id=3D"Upgradingfrom5.1to5.3-DefineaDoctrineconnection">Define a Doc=
trine connection</h4>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>MySQL settings : ezpublish.yml or config.yml</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: bash; gutter: false" style=3D"font-siz=
e:12px;">doctrine:
    dbal:
        connections:
            my_connection:
                driver:   pdo_mysql
               &nbsp;host:     localhost
                port:     3306
                dbname:   my_database
                user:     my_user
                password: my_password
                charset:  UTF8</pre>=20
</div>
</div>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">=20
<div class=3D"codeHeader panelHeader pdl hide-border-bottom" style=3D"borde=
r-bottom-width: 1px;">=20
<b class=3D" code-title">PostGreSQL : ezpublish.yml or config.yml </b>=20
<span class=3D"collapse-source expand-control"><span class=3D"expand-contro=
l-icon icon">&nbsp;</span><span class=3D"expand-control-text">Expand source=
</span></span>=20
</div>=20
<div class=3D"codeContent panelContent pdl hide-toolbar">=20
<pre class=3D"theme: Eclipse; brush: bash; collapse: true; gutter: false" s=
tyle=3D"font-size:12px;">doctrine:
    dbal:
        connections:
            my_connection:
                driver:   pdo_pgsql
                host:     localhost
                port:     5432
                dbname:   my_database
                user:     my_user
                password: my_password
                charset:  UTF8</pre>=20
</div>=20
</div>=20
<div class=3D"aui-message hint shadowed information-macro">=20
<p class=3D"title">Pro Tip</p>=20
<span class=3D"aui-icon icon-hint">Icon</span>=20
<div class=3D"message-content">
 Set your base DB params in your=20
<code>parameters.yml</code>/
<code>parameters.yml.dist</code> and refer them here.=20
</div>=20
</div>=20
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>parameters.yml</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">parameters:
   database_driver: pdo_mysql
   database_host: localhost
   database_port: 3306
   database_name: ezdemo
   database_user: my_user
   database_password: my_password
   database_charset: UTF8</pre>=20
</div>
</div>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>ezpublish.yml / config.yml</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">doctrine:
   dbal:
       connections:
           my_connection:
               driver:   %database_driver%
               host:     %database_host%
               port:     %database_port%
               dbname:   %database_name%
               user:     %database_user%
               password: %database_password%
               charset:  %database_charset%</pre>=20
</div>
</div></li>
<li><h4 id=3D"Upgradingfrom5.1to5.3-Defineoneorseveralrepositories">Define =
one or several repositories</h4>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>ezpublish.yml</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">ezpublish:
  repositories:
      main: { engine: legacy, connection: my_connection }</pre>=20
</div>
</div></li>
<li><h4 id=3D"Upgradingfrom5.1to5.3-(Optional)MakeyourSiteAccessconfigpoint=
totherightrepository">(Optional) Make your SiteAccess config point to the r=
ight repository</h4>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">=20
<div class=3D"codeHeader panelHeader pdl hide-border-bottom" style=3D"borde=
r-bottom-width: 1px;">=20
<b class=3D" code-title">ezpublish.yml</b>=20
<span class=3D"collapse-source expand-control"><span class=3D"expand-contro=
l-icon icon">&nbsp;</span><span class=3D"expand-control-text">Expand source=
</span></span>=20
</div>=20
<div class=3D"codeContent panelContent pdl hide-toolbar">=20
<pre class=3D"theme: Eclipse; brush: php; collapse: true; gutter: false" st=
yle=3D"font-size:12px;">ezpublish:
  system:
      my_siteaccess_group:
          repository: main</pre>=20
</div>=20
</div><p>&nbsp;</p>
<div class=3D"highlight highlight-yaml">
<p>&nbsp;</p>=20
<div class=3D"aui-message hint shadowed information-macro">=20
<p class=3D"title">Remove the old connection information</p>=20
<span class=3D"aui-icon icon-hint">Icon</span>=20
<div class=3D"message-content">=20
<p>Note : to benefit from the new configuration, don't forget to remove the=
 old configuration</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Old database access to remove</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">ezpublish:
    system:
        my_siteaccess_group:
            database:
                type: mysql
                user: my_user
                password: my_password
                server: localhost
                database_name: ezdemo
</pre>=20
</div>
</div>=20
</div>=20
</div>=20
</div></li>
</ul>
<h3 id=3D"Upgradingfrom5.1to5.3-Step4:Apply5.2&amp;5.3configurationchanges"=
>Step 4: Apply 5.2 &amp; 5.3 configuration changes</h3>
<h4 id=3D"Upgradingfrom5.1to5.3-YAMLfiles">YAML files</h4>
<p>Since default configuration files have been overwritten during step one,=
 the few additions to those files that were made in 5.3 need to be applied =
manually to the configuration files. All of those changes are&nbsp;<strong>=
additions</strong>, none of them replaces what you already have. For most o=
f them, at least one, if not all hierarchy elements (monolog, handler, fram=
ework, router...) will already be there. All you have to do is add the miss=
ing bits in the existing configuration blocks.</p>
<p>In&nbsp;<strong>ezpublish/config/config_dev.yml</strong>, add the config=
uration for the chromephp log handler:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">monolog:
    handlers:
        chromephp:
            type: chromephp
            level: info</pre>=20
</div>
</div>
<pre class=3D"wordwrap copytoclipboard"><span style=3D"font-family: Arial ,=
 sans-serif;font-size: 14.0px;line-height: 1.4285715;">In&nbsp;</span><stro=
ng style=3D"font-family: Arial , sans-serif;font-size: 14.0px;line-height: =
1.4285715;">ezpublish/config/config.yml</strong><span style=3D"font-family:=
 Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">, you need t=
o add a few default values for the framework</span></pre>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">framework:
    router:
        resource: &quot;%kernel.root_dir%/config/routing.yml&quot;
        strict_requirements: %kernel.debug%
    trusted_proxies: ~   &nbsp;
    http_method_override: true
&nbsp;
twig:   &nbsp;
    debug: %kernel.debug%
    strict_variables: %kernel.debug%</pre>=20
</div>
</div>
<h5 id=3D"Upgradingfrom5.1to5.3-Sessionname">Session name</h5>
<p><code>ezpublish.system.&lt;siteAccessName&gt;.session_name</code> has be=
en deprecated for defining session name. You now need to use <code>ezpublis=
h.system.&lt;siteAccessName&gt;.session.name</code>.</p>
<p><em>Before</em>:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">ezpublish:
    system:
        my_siteaccess:
            session_name: SomeSessionName</pre>=20
</div>
</div>
<p><em>After</em>:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">ezpublish:
    system:
        my_siteaccess:
            session:
                name: SomeSessionName</pre>=20
</div>
</div>
<h5 id=3D"Upgradingfrom5.1to5.3-Routing">Routing</h5>
<p>In&nbsp;<strong style=3D"font-size: 14.0px;line-height: 1.4285715;">rout=
ing_dev.yml</strong>, add the resource import for the SensioDistributionBun=
dle webconfigurator routes:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">_configurator:
    resource: &quot;@SensioDistributionBundle/Resources/config/routing/webc=
onfigurator.xml&quot;
    prefix: /_configurator</pre>=20
</div>
</div>
<pre class=3D"wordwrap"><span style=3D"font-family: Arial , sans-serif;font=
-size: 14.0px;line-height: 1.4285715;">&nbsp;</span></pre>
<p>In&nbsp;<strong>routing.yml</strong>, add <strong>new login routes</stro=
ng> and the&nbsp;<code>_ezpublishRestOptionsRoutes</code> route loader:</p>
<pre class=3D"wordwrap"><span style=3D"font-family: Arial , sans-serif;font=
-size: 14.0px;line-height: 1.4285715;">&nbsp;</span></pre>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">_ezpublishRestOptionsRoutes:
    resource: &quot;@EzPublishRestBundle/Resources/config/routing.yml&quot;
    prefix: %ezpublish_rest.path_prefix%
    type: rest_options
&nbsp;
login:
    path:   /login
    defaults:  { _controller: ezpublish.security.controller:loginAction }
login_check:
    path:   /login_check
logout:
    path:   /logout</pre>=20
</div>
</div>
<h5 class=3D"wordwrap" id=3D"Upgradingfrom5.1to5.3-SecurityInezpublish/conf=
ig/security.yml,addthefollowing:"><span style=3D"font-family: Arial , sans-=
serif;font-size: 14.0px;line-height: 1.4285715;"><span>&nbsp;</span>Securit=
y<br />In&nbsp;</span><strong style=3D"font-family: Arial , sans-serif;font=
-size: 14.0px;line-height: 1.4285715;">ezpublish/config/security.yml</stron=
g><span style=3D"font-family: Arial , sans-serif;font-size: 14.0px;line-hei=
ght: 1.4285715;">, add the following:</span></h5>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">access_control:   &nbsp;
    - { path: ^/login, roles: IS_AUTHENTICATED_ANONYMOUSLY, requires_channe=
l: https }</pre>=20
</div>
</div>
<p class=3D"wordwrap"><span style=3D"font-family: Arial , sans-serif;font-s=
ize: 14.0px;line-height: 1.4285715;"><span>And again in</span><strong> ezpu=
blish/config/security.yml</strong><span>, under <code>ezpublish_front</code=
> firewall, update to fit the following (<strong>be sure to remove <code>ez=
publish: true</code></strong>):</span></span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">security:
    firewalls:
        ezpublish_front:
            pattern: ^/
            anonymous: ~
            form_login:
                require_previous_session: false
            logout: ~</pre>=20
</div>
</div>
<p class=3D"wordwrap"><span style=3D"font-family: Arial , sans-serif;font-s=
ize: 14.0px;line-height: 1.4285715;">&nbsp;</span></p>
<p class=3D"wordwrap"><span>If you have added anything to <code>parameters.=
yml</code>, we suggest that you add your custom settings to <code>parameter=
s.yml.dist</code>, so that the composer post-update script handles those, a=
nd generates their values correctly.</span></p>
<h4 class=3D"wordwrap" id=3D"Upgradingfrom5.1to5.3-Templates"><span>Templat=
es</span></h4>
<p class=3D"wordwrap"><span>In your templates, change your links pointing t=
o <code>/user/login</code> and <code>/user/logout</code> to appropriate <co=
de>login&nbsp;</code>/ <code>login_check&nbsp;</code>/ <code>logout</code> =
routes:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Before</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: xml; gutter: false" style=3D"font-size=
:12px;">&lt;a href=3D&quot;{{ path( 'ez_legacy', {'module_uri': '/user/logi=
n'} ) }}&quot;&gt;Login&lt;/a&gt;
&lt;form action=3D&quot;{{ path( 'ez_legacy', {'module_uri': '/user/login'}=
 ) }}&quot; method=3D&quot;post&quot;&gt;
&lt;a href=3D&quot;{{ path( 'ez_legacy', {'module_uri': '/user/logout'} ) }=
}&quot;&gt;Logout&lt;/a&gt;</pre>=20
</div>
</div>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>After</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: xml; gutter: false" style=3D"font-size=
:12px;">&lt;a href=3D&quot;{{ path( 'login' ) }}&quot;&gt;Login&lt;/a&gt;
&lt;form action=3D&quot;{{ path( 'login_check' ) }}&quot; method=3D&quot;po=
st&quot;&gt;
&lt;a href=3D&quot;{{ path( 'logout' ) }}&quot;&gt;Logout&lt;/a&gt;</pre>=
=20
</div>
</div>
<h5 id=3D"Upgradingfrom5.1to5.3-ezpublish/EzPublishKernel.php">ezpublish/Ez=
PublishKernel.php</h5>
<p>It is not possible to just copy your old <code>EzPublishKernel.php</code=
> file over from the previous installation, since quite a few changes were =
made to this file in this release. We suggest that you simply reflect in th=
e new kernel file any changes you made in the previous version.</p>
<h5 id=3D"Upgradingfrom5.1to5.3-composer.json">composer.json</h5>
<p>If you had modified <code>composer.json</code> to add your own requireme=
nts, you must re-apply those changes to the new version, and run <code><str=
ong>composer update</strong></code>.</p>
<h4 id=3D"Upgradingfrom5.1to5.3-Varnish(ifapplicable)">Varnish (if applicab=
le)</h4>
<p>Anonymous state of a user is not checked through presence of <code>is_lo=
gged_in</code> cookie any more. Therefore, when using Varnish, you must cha=
nge the following in your VCL file:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Before</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;"># ez_user_hash sub-routine
if (req.http.Cookie !~ &quot;is_logged_in=3D&quot; ) {
    # User don't have &quot;is_logged_in&quot; cookie =3D&gt; Set a hardcod=
ed anonymous hash
    set req.http.X-User-Hash =3D &quot;38015b703d82206ebc01d17a39c727e5&quo=
t;;
}</pre>=20
</div>
</div>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>After</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;"># ez_user_hash sub-routine
if (req.http.Cookie !~ &quot;eZSESSID&quot; ) {
    # User don't have session cookie =3D&gt; Set a hardcoded anonymous hash
    set req.http.X-User-Hash =3D &quot;38015b703d82206ebc01d17a39c727e5&quo=
t;;
}</pre>=20
</div>
</div>
<h3 id=3D"Upgradingfrom5.1to5.3-Step5:Updateclusterdata(ifapplicable)">Step=
 5: Update cluster data (if applicable)</h3>
<p>If your installation uses the DFS cluster, you are affected by the&nbsp;=
<a href=3D"https://github.com/ezsystems/ezpublish-legacy/blob/master/doc/fe=
atures/5.2/dfs_split_tables.md" class=3D"external-link" rel=3D"nofollow">sp=
lit DFS tables feature</a>&nbsp;that was added in 5.2.&nbsp;You can also ch=
eck the&nbsp;<a href=3D"https://doc.ez.no/doc_hidden/eZ-Publish/Technical-m=
anual/5.x/Features/Clustering/Setting-it-up-for-an-eZDFSFileHandler" rel=3D=
"nofollow">DFS setup documentation</a>&nbsp;document on steps 3 and 4 for a=
dditional details and usage examples about the newly introduced configurati=
ons.</p>
<p>To use the feature, you need to update your DFS database structure. It w=
on't affect existing data, and doesn't require particular measures. Import =
the following file into your<em>cluster</em>&nbsp;database (it should be di=
fferent from your eZ Publish database):</p>
<pre class=3D"wordwrap"><span class=3D"line">/&lt;ezp5-root&gt;/ezpublish_l=
egacy/update/database/mysql/5.2/dbupdate-cluster-5.1.0-to-5.2.0.sql</span><=
/pre>
<p>The split table feature stores cache and storage into two different tabl=
es. For now, your ezdfsfile table contains both cache and storage. Starting=
 from now, eZ Publish will use the newly created table, ezdfsfile_cache, to=
 store cache. Since the table &nbsp;is empty, it will react as if there was=
 no cache, and work without any changes.</p>
<p>However, we recommend that you remove entries related to cache from your=
 ezdfsfile table. There are several options.</p>
<h6 id=3D"Upgradingfrom5.1to5.3-Option1:unclusterize,cleardata,andrecluster=
ize">Option 1: unclusterize, clear data, and reclusterize</h6>
<p><em>This method requires that you shutdown the website completely</em>&n=
bsp;for a little while. It mainly applies to small/medium websites (up to a=
 couple thousand content objects).</p>=20
<div class=3D"aui-message problem shadowed information-macro">=20
<p class=3D"title">May require a lot of disk space</p>=20
<span class=3D"aui-icon icon-problem">Icon</span>=20
<div class=3D"message-content">=20
<p>Since this method will create a local copy of every storage file (not in=
cluding cache) from your NFS to the local server, this method may require a=
 large amount of disk space. You can get an estimate of the required space =
by running the following query on your cluster database:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: sql; gutter: false" style=3D"font-size=
:12px;">SELECT SUM(size) from ezdfsfile WHERE name LIKE 'var/ezdemo\_site/s=
torage/%';</pre>=20
</div>
</div>
<p>It will give you the total size of storage items, in bytes. Remember to =
escape _ in your vardir.</p>=20
</div>=20
</div>=20
<p>Use the following commands from your&nbsp;<em>/&lt;ezp5-root&gt;/ezpubli=
sh_legacy/</em>&nbsp;folder:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">cd ezpublish_legacy
bin/php/clusterize.php -u</pre>=20
</div>
</div>
<p class=3D"wordwrap"><span style=3D"font-family: Arial , sans-serif;font-s=
ize: 14.0px;line-height: 1.4285715;">Next, truncate the ezdfsfile table fro=
m your database:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">TRUNCATE TABLE ezdfsfile</pre>=20
</div>
</div>
<p>And finally, re-create cluster data based on local data:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">cd ezpublish_legacy
bin/php/clusterize.php</pre>=20
</div>
</div>
<h6 id=3D"Upgradingfrom5.1to5.3-Option2:performabackgroundcleanupofthestora=
getable">Option 2: perform a background cleanup of the storage table</h6>
<p>An upgrade script is provided that will let you cleanup &nbsp;the ezdfsf=
ile table on a live website, even with a large cluster. It will delete a co=
nfigurable (by default 1000) batch of cache rows from ezdfsfile, and sleep =
(by default for 100 ms) between batches. Run the following from the legacy =
root:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">cd ezpublish_legacy
php update/common/scripts/5.2/cleanupdfscache.php -h</pre>=20
</div>
</div>
<p class=3D"wordwrap"><span style=3D"font-family: Arial , sans-serif;font-s=
ize: 14.0px;line-height: 1.4285715;">The script can be interrupted and rest=
arted anytime without risks for the system. We strongly suggest, if you exe=
cute it on a live website, that you monitor your database server's performa=
nces, and increase the sleep delay and/or decrease the limit if the SQL ser=
ver's load is too high.</span></p>
<h3 id=3D"Upgradingfrom5.1to5.3-Step6:Regeneratetheautoloadarrayforextensio=
ns">Step 6: Regenerate the autoload array for extensions</h3>
<p>To regenerate the autoload array, execute the following script from the =
root of your eZ Publish Legacy directory:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">cd ezpublish_legacy
php bin/php/ezpgenerateautoloads.php --extension</pre>=20
</div>
</div>
<h3 id=3D"Upgradingfrom5.1to5.3-Step7:Linkassets">Step 7: Link assets</h3>
<p>Assets from the various bundles need to be made available for the webser=
ver through the web/ document root.</p>
<p>The following commands will first symlink eZ Publish 5 assets in &quot;B=
undles&quot; and the second will symlink assets (design files like images, =
scripts and css, and files in var folder) &nbsp;from eZ Publish Legacy:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"theme: Eclipse; brush: php; gutter: false" style=3D"font-size=
:12px;">php ezpublish/console assets:install --symlink
php ezpublish/console ezpublish:legacy:assets_install --symlink
php ezpublish/console assetic:dump --env=3Dprod</pre>=20
</div>
</div>
<h3 id=3D"Upgradingfrom5.1to5.3-Step8:Updaterewriterules">Step 8: Update re=
write rules</h3>
<p>There are two ways eZ Publish 5 can be installed, either the full instal=
l with both the new Symfony stack and the legacy stack, or legacy only.&nbs=
p;In latter case you only need to point your '4.7 like' rewrite rules to&nb=
sp;<em>/&lt;ezp5-root&gt;/ezpublish_legacy/</em>&nbsp;and that's it. Otherw=
ise,&nbsp;update your virtual host according to&nbsp;<a href=3D"https://con=
fluence.ez.no/display/EZP/Virtual+host+setup" class=3D"external-link" rel=
=3D"nofollow">the eZ Publish 5.2 rewrite rules on confluence</a>&nbsp;and p=
oint your host configuration to&nbsp;<em>/&lt;ezp5-root&gt;/web/</em>.</p>
<h3 id=3D"Upgradingfrom5.1to5.3-Step9:Clearthecaches">Step 9: Clear the cac=
hes</h3>
<p>Whenever an eZ Publish solution is upgraded, all caches must be cleared =
in a proper way. This should be done from within a system shell:<br />Navig=
ate into the new eZ Publish directory.Run the script using the following sh=
ell command:cd /&lt;ezp5-root&gt;/ezpublish_legacy/php bin/php/ezcache.php =
--clear-all --purgePurging ensures that the caches are physically removed. =
When the &quot;--purge&quot; parameter is not specified, the caches will be=
 expired but not removed.<br />Note: Sometimes the script is unable to clea=
r all cache files because of restrictive file/directory permission settings=
. Make sure that all cache files have been cleared by inspecting the conten=
ts of the various cache sub-directories within the &quot;var&quot; director=
y (typically the &quot;var/cache/&quot; and &quot;var/&lt;name_of_siteacces=
s&gt;/cache/&quot; directories). If there are any cache files left, you nee=
d to remove them manually.</p>
<h3 id=3D"Upgradingfrom5.1to5.3-Step10:UpgradeExtensions(sitepackage)">Step=
 10: Upgrade Extensions (site package)</h3>
<p>Next, depending on if you originally installed eZ Flow, eZ Webin or eZ D=
emo site, follow the steps mentioned in the&nbsp;<a href=3D"https://doc.ez.=
no/doc_hidden/Extensions/eZ-Publish-extensions/Website-Interface/Website-in=
terface-5.3-upgrade" rel=3D"nofollow">eZ Webin</a>,&nbsp;<a href=3D"https:/=
/doc.ez.no/doc_hidden/Extensions/eZ-Publish-extensions/eZ-Flow/Upgrading-eZ=
-Flow/eZ-Flow-5.3-upgrade" rel=3D"nofollow">eZ Flow</a>&nbsp;or&nbsp;<a hre=
f=3D"https://doc.ez.no/doc_hidden/Extensions/eZ-Publish-extensions/eZ-Demo/=
eZ-Demo-5.3-upgrade" rel=3D"nofollow">eZ Demo</a>&nbsp;upgrade documentatio=
n.</p>
    </div>
</body>
</html>
------=_Part_759_446658023.1413881533730--
